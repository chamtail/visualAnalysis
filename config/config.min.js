$.ajaxSettings.async = false;  // 同步执行
/**
 * js动态生成配置文件
 * Created by Jeremy on 2018/11/23.
 */

/**
 * 获取所有节点状态
 * @type {{}}
 */
var nodes = {};
$.getJSON("../config/nodes.json", function (data) {
    $.each(data, function (node, status) {
        nodes[node] = status;
    })
});

/**
 * 获取节点类别
 * @type {{}}
 */
var category_list = {};  // 节点类别
$.getJSON("../config/category.json", function (data) {
    $.each(data, function (category, content) {
        category_list[category] = content;
    })
});
// console.log(category_list);

/**
 * 遍历所有节点，获取节点信息
 */
var nodes_category = {};  // 节点类别
var node_config = {};  // 节点配置
var node_params = {};  // 节点参数
$.each(nodes, function (node, status) {
    if (status == "enable") {
        // 读取该节点配置文件
        $.getJSON("../config/nodes/" + node + ".json", function (nodeConfig) {
            var category = nodeConfig.category;
            var subModule = "";
            var modules = category.split("/");
            category = modules[0];
            subModule = modules[1];

            // 添加节点类别
            if (!category_list[category]) {
                console.error("category doesn't have this category!");
                return;
            }
            if (!nodes_category[category]) {
                nodes_category[category] = category_list[category];
            }

            // 判断该类别下是否含有子模块
            if (subModule && category_list[subModule]) {
                if (!nodes_category[category].sub_modules) {
                    nodes_category[category].sub_modules = {};
                }
                if (!nodes_category[category].sub_modules[subModule]) {
                    nodes_category[category].sub_modules[subModule] = category_list[subModule];
                    nodes_category[category].sub_modules[subModule]["nodes"] = {};
                }
                nodes_category[category].sub_modules[subModule]["nodes"][node] = {
                    "zh": nodeConfig.display.zh,
                    "en": nodeConfig.display.en,
                    "in": nodeConfig.in,
                    "out": nodeConfig.out
                };
            } else {
                if (!nodes_category[category]["nodes"]) {
                    nodes_category[category]["nodes"] = {};
                }
                nodes_category[category]["nodes"][node] = {
                    "zh": nodeConfig.display.zh,
                    "en": nodeConfig.display.en,
                    "in": nodeConfig.in,
                    "out": nodeConfig.out
                };
            }

            // 添加节点配置
            node_config[node] = nodeConfig;

            if (!node_params[node]) {
                node_params[node] = [];
            }
            // 添加节点参数
            for (var i = 0; i < nodeConfig.params.length; i++) {
                if (nodeConfig.params[i].enable && nodeConfig.params[i].configurable) {
                    node_params[node].push(nodeConfig.params[i].name);
                }
            }
        });
    }
});
// console.log(JSON.stringify(nodes_category));
// console.log(JSON.stringify(node_config));
// console.log(JSON.stringify(node_params));

/**
 * API
 */
var api_map = {};
$.getJSON("../config/api.json", function (data) {
    $.each(data, function (api, address) {
        api_map[api] = address.protocol + "://" + address.host + ":" + address.port + address.api;
    });
});
// console.log(JSON.stringify(api_map));

/**
 * 节点状态
 */
var nodeStatusMap = {};
$.getJSON("../config/nodeStatus.json", function (data) {
    $.each(data, function (code, status) {
        nodeStatusMap[code] = status;
    });
});
// console.log(JSON.stringify(nodeStatusMap));