<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>数据流可视化分析平台</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="数据流可视化分析平台">
    <meta name="author" content="yzs">

    <link href="../public/css/bootstrap.min.css" rel="stylesheet">
    <link href="../public/css/font-awesome.min.css" rel="stylesheet">
    <link href="../public/css/jquery-ui.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../public/css/index.css">
    <script src="../public/js/jquery.min.js"></script>
    <script src="../public/js/popper.min.js"></script>
    <script src="../public/js/bootstrap.min.js"></script>
    <script src="../public/js/jquery-ui.min.js"></script>
    <script src="../public/js/d3.min.js"></script>
    <script src="../public/js/d3-transform.min.js"></script>
    <script src="../public/js/vue.min.js"></script>

</head>
<body>
<div id="vm">
    <div id="header">
        <span class="logo">
            <img src="./public/node-red.png" title="0.19.5">
            <span>数据流可视化分析平台</span>
        </span>
        <ul class="header-toolbar hide" style="display: block;">
            <li style="display: none;">
                <a id="btn-notifications" class="button" href="#">
                    <i class="fa fa-warning"></i>
                </a>
            </li>
            <li>
                <span class="deploy-button-group button-group">
                    <a id="btn-deploy" class="deploy-button" @click="deploy">
                        <span class="deploy-button-content" style="opacity: 1;">
                            <img id="btn-deploy-icon" src="./public/deploy-full-o.png">
                            <span>Deploy</span>
                        </span>
                        <span class="deploy-button-spinner hide" style="display: none;"><img
                                src="./public/spin.svg"></span>
                    </a>
                </span>
            </li>
        </ul>
        <div id="header-shade" class="hide" style="display: none;"></div>
    </div>
    <div id="main-container">
        <div id="left-wrapper" class="left-wrapper">
            <ul class="sidebar-nav">
                <li>
                    <a class="open">
                        <i class="fa fa-folder-o"></i>
                        <span>Input</span>
                    </a>
                    <ul>
                        <li class="node" data-template-name="data-upload">
                            <a href="#">
                                <i class="fa fa-database"></i>
                                <span>数据上传</span>
                            </a>
                        </li>
                        <li class="node" data-template-name="data-load">
                            <a href="#">
                                <i class="fa fa-database"></i>
                                <span>数据加载</span>
                            </a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a>
                        <i class="fa fa-folder-o"></i>
                        <span>Process</span>
                    </a>
                    <ul>
                        <li class="node" data-template-name="outlier-detection">
                            <a href="#">
                                <i class="fa fa-crosshairs" aria-hidden="true"></i>
                                <span>异常检测</span>
                            </a>
                        </li>
                        <li class="node" data-template-name="normalization">
                            <a href="#">
                                <i class="fa fa-crosshairs" aria-hidden="true"></i>
                                <span>标准化</span>
                            </a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a>
                        <i class="fa fa-folder-o"></i>
                        <span>Output</span>
                    </a>
                    <ul>
                        <li class="node" data-template-name="data-save">
                            <a href="#">
                                <i class="fa fa-crosshairs" aria-hidden="true"></i>
                                <span>保存数据</span>
                            </a>
                        </li>
                        <li class="node" data-template-name="model-save">
                            <a href="#">
                                <i class="fa fa-crosshairs" aria-hidden="true"></i>
                                <span>保存模型</span>
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class="middle-wrapper">
            <div id="idsw-bpmn" class="bpmn" style="position: relative; width: 100%; height: 100%;">
                <svg width="100%" height="100%">
                    <defs>
                        <marker id="arrowhead" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6"
                                orient="auto">
                            <path d="M 0 0 L 10 5 L 0 10 z" stroke-width="0" stroke="#333"></path>
                        </marker>
                    </defs>
                </svg>
            </div>
            <!--<div style="height: 40px; border-top: solid 1px #e7e7e7; text-align: center; line-height: 40px; position: absolute;bottom: 2px; width: 100%">-->
            <!--<a class="btn btn-link" href="#"><i class="fa fa-play-circle-o" aria-hidden="true"></i>&nbsp;运行</a>-->
            <!--<a class="btn btn-link" href="#"><i class="fa fa-cloud-upload" aria-hidden="true"></i>&nbsp;部署</a>-->
            <!--<a class="btn btn-link" href="#"><i class="fa fa-share-alt" aria-hidden="true"></i>&nbsp;分享</a>-->
            <!--</div>-->
        </div>
        <div class="right-wrapper">
            <button class="btn btn-primary" onclick="debug()"></button>

        </div>
        <div id="sidebar-separator" class="ui-draggable"></div>
    </div>
    <div class="modal fade" id="nodeParamsModal" tabindex="-1" role="dialog" aria-labelledby="nodeParamsModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nodeParamsModalLabel">{{node.type}}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form method="post" id="main-form">
                        <template v-if="node.attrs.length != 0">
                            <template v-for="(model, index) in node.attrs">
                                <div class="form-group">
                                    <label :for="model.name" class="col-sm-3">{{model.label[lang]}}</label>
                                    <template v-if="model.type == 'list'">
                                        <select :name="model.name" class="col-sm-8">
                                            <option value="">全部</option>
                                            <template v-for="(option, id) in model.list">
                                                <option :value="option" :selected="model.default == id || model.default == option">{{option}}</option>
                                            </template>
                                        </select>
                                    </template>
                                    <template v-else-if="model.type == 'richtext'">
                                        <textarea :type="model.type" class="col-sm-8" :name="model.name" :placeholder="model.default">{{model.default}}</textarea>
                                    </template>
                                    <!--<template v-else-if="model.type == 'path'">-->
                                        <!---->
                                    <!--</template>-->
                                    <template v-else>
                                        <input :type="model.type" class="col-sm-8" :name="model.name" :placeholder="model.default" :value="model.default">
                                    </template>
                                </div>
                            </template>

                        </template>
                        <template v-else>
                            <div class="form-group">
                                抱歉，暂时不可配置～
                            </div>
                        </template>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="onNodeConfig()">确定</button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>

<script src="../config/config.js"></script>
<script src="../public/js/node-drag.js"></script>
<script src="../public/js/cookie.js"></script>
<script src="../public/js/plupload/plupload.full.min.js"></script>
<script>
    // 说明：获取鼠标位置
    // 整理：http://www.codebit.cn
    // 来源：http://www.webreference.com
    function mousePosition(ev) {
        if (ev.pageX || ev.pageY) {
            return {x: ev.pageX, y: ev.pageY};
        }
        return {
            x: ev.clientX + document.body.scrollLeft - document.body.clientLeft,
            y: ev.clientY + document.body.scrollTop - document.body.clientTop
        };
    }
    document.onmousemove = mouseMove;

    function mouseMove(ev) {
        ev = ev || window.event;
        var mousePos = mousePosition(ev);
        //console.log("x: "+mousePos.x+"   y: " + mousePos.y);
    }
    //vue 绑定
    var vm = new Vue({
        el: '#vm',
        data: {
            node: {
                id: -1,
                type: "",
                attrs: []
            },
            selected:"aa",
            lang: getCookieValue("lang")
        },
        mounted: function () {
            $(function () {
                init();
                if (vm.lang == "") {
                    vm.lang = 'zh';
                }
            })
        },
        methods: {
            deploy: function () {
                var nodes = [];
                for (var tabIndex in workflow.nodes) {
                    for (var nodeId in workflow.nodes[tabIndex]) {
                        var node = workflow.nodes[tabIndex][nodeId];
                        node['next'] = workflow.links[node.id];
                        if (workflow.links[node.id]) {
                            node['next'] = workflow.links[node.id];
                        } else {
                            node['next'] = [];
                        }
                        console.log(node);
                        nodes.push(node);
                    }
                }

                var flows = []; // 工作流
                for (var i = 0, len = workflow.tab.length; i < len; i++) {
                    flows.push(workflow.tab[i]);
                }
                for (var i = 0, len = nodes.length; i < len; i++) {
                    flows.push(nodes[i]);
                }

                // 模型建立请求
                var model = {};
                model['flows'] = flows;
                model['ver'] = -1;
                console.log("flows: " + JSON.stringify(flows));

            },
            onNodeConfig: function () {
                var data = $('#main-form').serializeArray();
                $.each(data, function () {
                    workflow.nodes[currentTab][vm.node.id][this.name] = this.value;
                });
                $('#nodeParamsModal').modal('hide');

                console.log("更改后： " , workflow.nodes[currentTab][vm.node.id]);
            }
        }

    });

    function debug() {
//        workflow.tab.push({
//            id: ++currentTab,
//            type: "tab",
//            label: "Flow "+currentTab,
//            disabled: false,
//            info: "",
//        });
        changLang();
    }

    function onNodeClick(id) {
        $('.node').attr('class', 'node');
        var node = $('#' + id);
        node.attr('class', 'node active');
        var nodeType = node.attr("data-template-name");
        var attrs = [];

        var attrInfo = params[nodeType]['attr'];
        var currentParams = workflow.nodes[currentTab][id];

        console.log("更改前： " , currentParams);

        var keyList = {};
        for(var key in currentParams){
            keyList[key] = 1;
        }
        console.log(keyList);
        for (var i = 0, len = attrInfo.length; i < len; i++) {
            if (attrInfo[i]['enable'] && attrInfo[i]['configurable']) {
                for(var key in keyList){
                    if(attrInfo[i]['name'] == key){
                        console.log(key);
                        attrInfo[i]['default'] = currentParams[key];
                    }
                }
                attrs.push(attrInfo[i]);
            }
        }
        vm.node.id = id;
        vm.node.type = params[nodeType]['display'][vm.lang];
        vm.node.attrs = attrs;
        console.log(vm.node.id, vm.node.type, vm.node.attrs);
    }

    function onNodeRun(id) {
        $('#' + id + ' .run')
                .attr('onclick', 'onNodePause(' + id + ')')
                .attr('fill', '#ff7f0e !important')
                .text('\uf04c');
    }

    function onNodePause(id) {
        $('#' + id + ' .run')
                .attr('onclick', 'onNodeRun(' + id + ')')
                .attr('fill', '#1aad19 !important')
                .text('\uf04b');
    }

    // 更改语言
    function changLang() {
        if (vm.lang == 'en') {
            vm.lang = 'zh';
        } else {
            vm.lang = 'en';
        }
        setCookie('lang', vm.lang, 24, "/");
    }
</script>