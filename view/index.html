<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>数据流可视化分析平台</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="数据流可视化分析平台">
    <meta name="author" content="yzs">

    <link href="../public/css/bootstrap.min.css" rel="stylesheet">
    <link href="../public/css/font-awesome.min.css" rel="stylesheet">
    <link href="../public/css/jquery-ui.min.css" rel="stylesheet">
    <script src="../public/js/jquery.min.js"></script>
    <script src="../public/js/popper.min.js"></script>
    <script src="../public/js/bootstrap.min.js"></script>
    <script src="../public/js/jquery-ui.min.js"></script>
    <script src="../public/js/d3.min.js"></script>
    <script src="../public/js/d3-transform.min.js"></script>
    <script src="../public/js/vue.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../public/css/index.css">
    <link rel="stylesheet" type="text/css" href="../public/custom/node/node.css">
</head>
<body>
<div id="vm">
    <div id="header">
        <span class="logo">
            <img src="./public/node-red.png" title="0.19.5">
            <span>数据流可视化分析平台</span>
        </span>
        <ul class="header-toolbar hide" style="display: block;">
            <li style="display: none;">
                <a id="btn-notifications" class="button" href="#">
                    <i class="fa fa-warning"></i>
                </a>
            </li>
            <li>
                <span class="deploy-button-group button-group">
                    <a id="btn-deploy" class="deploy-button" @click="deploy">
                        <span class="deploy-button-content" style="opacity: 1;">
                            <img id="btn-deploy-icon" src="./public/deploy-full-o.png">
                            <span>Deploy</span>
                        </span>
                        <span class="deploy-button-spinner hide" style="display: none;"><img
                                src="./public/spin.svg"></span>
                    </a>
                </span>
            </li>
        </ul>
        <div id="header-shade" class="hide" style="display: none;"></div>
    </div>
    <div id="main-container">
        <!-- 动态加载工作流组件 -->
        <div id="left-wrapper" class="left-wrapper">
            <img src="../public/images/spin.svg" class="node-spinner hide" style="display: none;">
            <div id="node-search" class="node-search">
                <div class="searchBox-container">
                    <i class="fa fa-search"></i>
                    <input type="text" data-i18n="[placeholder]node.filter" placeholder="filter nodes">
                    <a href="#"><i class="fa fa-times"></i></a>
                    <span class="searchBox-resultCount hide"></span>
                </div>
            </div>
            <div id="node-container" class="node-scroll">
                <template v-for="(module, key) in nodes">
                    <div :id="'node-container-' + key" class="node-category node-close hide node-open"
                         style="display: block;">
                        <div class="node-content" :id="'node-base-category-'+key" style="">
                            <div :id="'node-header-' + key" class="node-header">
                                <i class="expanded fa fa-angle-down"></i>
                                <span>{{module['display'][lang]}}</span>
                            </div>
                            <div v-for="(info, key) in module">
                                <template v-if="key=='nodes'">
                                    <template v-for="(node, key) in info">
                                        <div class="node" :data-template-name="key"
                                             style="background-color: #fff; height: 30px">
                                            <div class="node_label" dir="">{{node[lang]}}</div>
                                            <div class="node_icon_container">
                                                <div class="node_icon"
                                                     :style="'background-image: url(../public/images/'+node+'.png)'"></div>
                                            </div>

                                            <template v-if="node['out'] != 0">
                                                <div class="node_port node_port_output" style="top: -48px;"></div>
                                            </template>
                                            <template v-if="node['in'] != 0">
                                                <div class="node_port node_port_input"
                                                     :style="node['out'] != 0 ? 'top: -58px;' : 'top: -48px;'"></div>
                                            </template>
                                        </div>
                                    </template>
                                </template>
                                <template v-else-if="key=='sub_modules'">
                                    <template v-for="module in info">
                                        <div :id="'node-header-' + key" class="node-header">
                                            <i class="fa fa-plus-circle" aria-hidden="true"></i>
                                            <span>{{module['display'][lang]}}</span>
                                        </div>
                                        <div v-for="(node, key) in module['nodes']">
                                            <div class="node" :data-template-name="key"
                                                 style="background-color: #fff; height: 30px;">
                                                <div class="node_label" dir="">{{node[lang]}}</div>
                                                <div class="node_icon_container">
                                                    <div class="node_icon"
                                                         :style="'background-image: url(../public/images/'+node+'.png)'"></div>
                                                </div>
                                                <template v-if="node['out'] != 0">
                                                    <div class="node_port node_port_output" style="top: -48px;"></div>
                                                </template>
                                                <template v-if="node['in'] != 0">
                                                    <div class="node_port node_port_input" style="top: -58px;"></div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            <div id="node-footer">
                <a class="node-button" id="node-collapse-all" href="#"><i
                        class="fa fa-angle-double-up"></i></a>
                <a class="node-button" id="node-expand-all" href="#"><i
                        class="fa fa-angle-double-down"></i></a>
            </div>
            <div id="node-shade" class="hide"></div>
        </div>
        <!-- 工作空间 -->
        <div class="middle-wrapper">
            <div id="accordion">
                <div class="card">
                    <div class="card-header" id="headingOne">
                        <h5 class="mb-0">
                            <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                工作流设计
                            </button>
                        </h5>
                    </div>

                    <div id="collapseOne" class="collapse show" aria-labelledby="headingOne">
                        <div class="card-body">
                            <nav>
                                <div class="row">
                                    <div class="btn-group" role="group" aria-label="Basic example">
                                        <button id="new_wf" type="button" class="btn btn-secondary">New</button>
                                        <button id="save_wf" type="button" class="btn btn-secondary">Save</button>
                                        <button id="del_wf" type="button" class="btn btn-secondary">Del</button>
                                    </div>
                                    <span> &nbsp;</span>
                                    <div class="nav nav-tabs" id="nav-tab" role="tablist">
                                        <a class="nav-item nav-link active" id="nav-wf-1" data-toggle="tab" href="#nav-1" role="tab" aria-controls="nav-1" aria-selected="true">Workflow1</a>
                                    </div>
                                </div>
                            </nav>
                            <div class="tab-content" id="nav-tabContent">
                                <div class="tab-pane fade show active" id="nav-1" role="tabpanel" aria-labelledby="nav-wf-1">1
                                    <div id="workflow" class="workflow" style="position: relative; width: 100%; height: 100%;">
                                        <svg width="100%" height="100%" style="z-index: 9998;"></svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header" id="headingTwo">
                        <h5 class="mb-0">
                            <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                可视化界面
                            </button>
                        </h5>
                    </div>
                    <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo">
                        <div class="card-body">
                            <span>graph here</span>
                            <div id="sample" style="height: 380px"></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header" id="headingThree">
                        <h5 class="mb-0">
                            <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                命令行界面
                            </button>
                        </h5>
                    </div>
                    <div id="collapseThree" class="collapse" aria-labelledby="headingThree">
                        <div class="card-body">
                            <div class="input-group">
                                <label class="input-group-addon">In[1]</label>
                                <input type="text" class="form-control" aria-label="Recipient's username" aria-describedby="basic-addon2">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button">Submit</button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <!--<div style="height: 40px; border-top: solid 1px #e7e7e7; text-align: center; line-height: 40px; position: absolute;bottom: 2px; width: 100%">-->
            <!--<a class="btn btn-link" href="#"><i class="fa fa-play-circle-o" aria-hidden="true"></i>&nbsp;运行</a>-->
            <!--<a class="btn btn-link" href="#"><i class="fa fa-cloud-upload" aria-hidden="true"></i>&nbsp;部署</a>-->
            <!--<a class="btn btn-link" href="#"><i class="fa fa-share-alt" aria-hidden="true"></i>&nbsp;分享</a>-->
            <!--</div>-->
        </div>
        <!-- 信息栏 -->
        <div class="right-wrapper">
            <button class="btn btn-primary" onclick="debug()"></button>
        </div>
        <div id="sidebar-separator" class="ui-draggable"></div>
    </div>
    <div class="modal fade" id="nodeParamsModal" tabindex="-1" role="dialog" aria-labelledby="nodeParamsModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nodeParamsModalLabel">{{node.type}}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form method="post" id="main-form">
                        <template v-if="node.attrs.length != 0">
                            <template v-for="(model, index) in node.attrs">
                                <div class="form-group">
                                    <label :for="model.name" class="col-sm-3">{{model.label[lang]}}</label>
                                    <template v-if="model.type == 'list'">
                                        <select :name="model.name" class="col-sm-8">
                                            <option value="">全部</option>
                                            <template v-for="(option, id) in model.list">
                                                <option :value="option"
                                                        :selected="model.default == id || model.default == option">
                                                    {{option}}
                                                </option>
                                            </template>
                                        </select>
                                    </template>
                                    <template v-else-if="model.type == 'richtext'">
                                        <textarea :type="model.type" class="col-sm-8" :name="model.name"
                                                  :placeholder="model.default">{{model.default}}</textarea>
                                    </template>
                                    <!--<template v-else-if="model.type == 'path'">-->
                                    <!---->
                                    <!--</template>-->
                                    <template v-else>
                                        <input :type="model.type" class="col-sm-8" :name="model.name"
                                               :placeholder="model.default" :value="model.default">
                                    </template>
                                </div>
                            </template>

                        </template>
                        <template v-else>
                            <div class="form-group">
                                抱歉，暂时不可配置～
                            </div>
                        </template>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" @click="deleteNode()">删除</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveNodeConfig()">确定</button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>

<script src="../config/config.js"></script>
<script src="../public/custom/node/node.js"></script>
<script src="../public/js/cookie.js"></script>
<script src="../public/js/Echarts/echarts.js"></script>
<script src="../public/custom/charts/charts.js"></script>
<script>
    // 说明：获取鼠标位置
    // 整理：http://www.codebit.cn
    // 来源：http://www.webreference.com
    function mousePosition(ev) {
        if (ev.pageX || ev.pageY) {
            return {x: ev.pageX, y: ev.pageY};
        }
        return {
            x: ev.clientX + document.body.scrollLeft - document.body.clientLeft,
            y: ev.clientY + document.body.scrollTop - document.body.clientTop
        };
    }
    document.onmousemove = mouseMove;

    function mouseMove(ev) {
        ev = ev || window.event;
        var mousePos = mousePosition(ev);
        //console.log("x: "+mousePos.x+"   y: " + mousePos.y);
    }
    //vue 绑定
    var vm = new Vue({
        el: '#vm',
        data: {
            init_finish: false,
            nodes: {},
            node: {
                id: "-1",
                type: "",
                attrs: []
            },
            path:{
                id: "",
                from: "-1",
                to: "-1"
            },
            selected: "aa",
            lang: getCookieValue("lang"),
            positionX: 0,
            positionY: 0
        },
        mounted: function () {
            $(function () {
                //工作流里的按钮
                button_op();
                // 默认有一个tabs
                workflow.tab.push({
                    id: currentTab,
                    type: "tab",
                    label: "Flow " + currentTab,
                    disabled: false,
                    info: "",
                });
                // 初始化左侧组件栏
                vm.nodes = nodes_category;
                if (vm.lang == "") {
                    vm.lang = 'zh';
                }
            });
            // 键盘事件
            $(function () {
                $(document).ready(
                        function () {
                            document.onkeydown = function () {
                                var oEvent = window.event;
                                if (oEvent.keyCode === 46) {
                                    console.log(vm.path);
                                    //逻辑处理
                                    if(vm.node.id != "-1"){
                                        onNodeDelete(vm.node.id);
                                    }
                                    if(vm.path.id != "-1"){
                                        onPathDelete(vm.path.id);
                                    }

                                    // 重置
                                    reset();
                                }
                            }
                        });
            });

            // svg事件
            $(function () {
                $('svg').click(function () {
                    //reset();
                });
            });
        },
        updated: function () {
            // 初始化node拖拽
            if (!vm.init_finish) {  // 确保只初始化一次
                init();
                vm.init_finish = true;
            }
        },
        methods: {
            deploy: function () {
                var routers = {};
                for (var tabIndex in workflow.nodes) {
                    for (var nodeId in workflow.nodes[tabIndex]) {
                        var node_origin = workflow.nodes[tabIndex][nodeId];
                        var node_type = node_origin['type'];
                        var node_id = node_origin['id'];
                        var node = {};
                        node.pId = tabIndex;
                        node.id = node_id;
                        node.type = node_type;
                        if (workflow.links[node_id] && workflow.links[node_id].length != 0) {
                            node.linkTo = workflow.links[node_id];
                        } else {
                            node.linkTo = [-1];
                        }
                        var algoParamsList = algoParams[node_type];
                        node.params = [];
                        for(var i=0, len=algoParamsList.length; i<len; i++){
                            var param_name = algoParamsList[i];
                            node.params.push(node_origin[param_name]);
                        }
                        routers[node_id] = node;
                    }
                }

                // 解析工作流，生成链表
                var head = {};  // 记录每个tab上的头节点id
                var link = {};  // 记录每个tab上的链表
                var traveled = {};  // 记录每个tab上已访问的节点id
                var last = -1;
                for(var tab in routers){
                    console.log(routers[tab], routers[tab].linkTo);
                    var pId = routers[tab].pId;  // 获取tab的id
                    var id = routers[tab].id;  // 获取节点id
                    if(!traveled[pId]){
                        traveled[pId] = {};
                    }
                    if(traveled[pId][id]){ //如果遍历过，跳过
                        continue;
                    }
                    traveled[pId][id] = 1;  // 记录更新当前tab已访问的节点id

                    head[pId] = id;  // 记录更新当前tab的头节点id
                    var next = routers[tab].linkTo[0];  // 获取下一个节点的id
                    if(!link[pId]){  // 初始化tab下的链表
                        link[pId] = {};
                    }
                    if(!link[pId][id]){  // 初始化当前tab的链表
                        link[pId][id] = {};
                    }

                    link[pId][id].nid = id;
                    link[pId][id].before = last;
                    link[pId][id].after = routers[tab].linkTo[0];
                    link[pId][id].algorithm = routers[tab].type;
                    link[pId][id].params = routers[tab].params;

                    last = id;  // 记录当前id
                    while(next != -1 && !traveled[next]){
                        link[pId][next] = {};
                        link[pId][next].nid = next;
                        link[pId][next].before = last;
                        link[pId][next].after = routers[next].linkTo[0];
                        link[pId][next].algorithm = routers[next].type;
                        link[pId][next].params = routers[next].params;
                        traveled[pId][next] = 1;

                        last = next;  // 更新last
                        next = routers[next].linkTo[0]; // 更新next变量
                        traveled[pId][next] = 1;
                    }
                }

                // 将节点路由信息转换为节点列表
                var nodeList = {};
                for(var tabId in head){
                    var nodeId = head[tabId];
                    var node = link[tabId][nodeId];
                    var nextId = node.after;
                    nodeList[nodeId] = node;
                    while (nextId != -1){
                        node = link[tabId][nextId];
                        nodeList[nextId] = node;
                        nextId = node.after;
                    }
                }
                // 模型建立请求
                var request = {};
                request.verCode = workflow.verCode;
                request.routers = nodeList;
                console.log(request);
                var data = JSON.stringify(request);
                // 发送工作流
                $.ajax({
                    url:"http://localhost:8889/workflow/init",
                    type:'POST',
                    data:data,
                    contentType:'application/json',
                    success:function(res){
                        if(res.code == 0){
                            workflow.verCode = res.data.verCode;
                        } else{
                            alert('error');
                        }
                    }
                });
            },
            saveNodeConfig: function () {
                $('#nodeParamsModal').modal('hide');
                var data = $('#main-form').serializeArray();
                $.each(data, function () {
                    workflow.nodes[currentTab][vm.node.id][this.name] = this.value;
                });
            },
            deleteNode: function () {
                onNodeDelete(vm.node.id);
                $('#nodeParamsModal').modal('hide');
            },
        }
    });

    function debug() {
        // 修改语言
        //changLang();
        // 画图事件
        showGraph();
    }

    // 显示节点细节
    function onNodeDetail(id) {
        // 重制
        reset();
        $('#'+id).attr('class', 'node active');
        vm.node.id = id;
        console.log('显示节点细节');
    }

    // 配置节点
    function onNodeConfig(id) {
        // 重置
        reset();
        // 显示配置窗口
        $('#nodeParamsModal').modal('show');
        var node = $('#'+id);
        node.attr('class', 'node active');
        var nodeType = node.attr("data-template-name");
        var attrs = [];

        var attrInfo = params[nodeType]['attr'];
        var currentParams = workflow.nodes[currentTab][id];

        var keyList = {};
        for (var key in currentParams) {
            keyList[key] = 1;
        }
        for (var i = 0, len = attrInfo.length; i < len; i++) {
            if (attrInfo[i]['enable'] && attrInfo[i]['configurable']) {
                for (var key in keyList) {
                    if (attrInfo[i]['name'] == key) {
                        console.log(key);
                        attrInfo[i]['default'] = currentParams[key];
                    }
                }
                attrs.push(attrInfo[i]);
            }
        }
        vm.node.id = id;
        vm.node.type = params[nodeType]['display'][vm.lang];
        vm.node.attrs = attrs;
    }

    // 运行节点
    function onNodeRun(id) {
        $('#' + id + ' .run')
                .attr('onclick', 'onNodePause(' + id + ')')
                .attr('fill', '#ff7f0e !important')
                .text('\uf04c');
    }

    // 暂停节点
    function onNodePause(id) {
        $('#' + id + ' .run')
                .attr('onclick', 'onNodeRun(' + id + ')')
                .attr('fill', '#1aad19 !important')
                .text('\uf04b');
    }

    // 删除节点
    function onNodeDelete(id) {
        console.log("删除节点#" + id);
        // 删除与之相连的路径
        d3.selectAll('path[from="' + id + '"]').remove();
        d3.selectAll('g[id="' + id + '"]').remove();
        d3.selectAll('path[to="' + id + '"]').remove();

        // 删除workflow中的记录
        var node = workflow.nodes[currentTab][id];
        workflow.used[node.type] -= 1;
        delete workflow.nodes[currentTab][id];
        delete workflow.links[node.id];

        for(var nodeId in workflow.nodes[currentTab]){
            if(workflow.links[nodeId]){
                console.log(nodeId, workflow.links[nodeId]);
                var index = workflow.links[nodeId].indexOf(id.toString());
                if (index > -1) {
                    workflow.links[nodeId].splice(index, 1);
                }
            }
        }
        console.log(workflow);

        // 重置
        reset();
    }
    // 点击连线
    function onPathClick(id) {
        // 重置
        reset();
        d3.select('path[id="' + id + '"]').attr('class', 'cable active');
        vm.path.from = d3.select('path[id="' + id + '"]').attr('from');
        vm.path.to = d3.select('path[id="' + id + '"]').attr('to');
        vm.path.id = id;
        console.log(vm.path);
    }
    // 删除连线
    function onPathDelete(id) {
        d3.select('path[id="' + id + '"]').remove();
        var nodeIds = id.split("_");
        var sId = nodeIds[0];
        var eId = nodeIds[1];
        console.log(sId, eId);
        var index = workflow.links[sId].indexOf(eId.toString());
        if (index > -1) {
            workflow.links[sId].splice(index, 1);
        }
        console.log(workflow);

        // 重置
        reset();
    }
    // 更改语言
    function changLang() {
        if (vm.lang == 'en') {
            vm.lang = 'zh';
        } else {
            vm.lang = 'en';
        }
        setCookie('lang', vm.lang, 24, "/");
    }
    // 重置参数
    function reset() {
        d3.selectAll('svg .node').attr('class', 'node');
        d3.selectAll('svg .cable').attr('class', 'cable');
        vm.node = {
            id: "-1",
            type: "",
            attrs: []
        };
        vm.path = {
            id: "-1",
            from: "-1",
            to: "-1"
        };
    }

    function button_op() {
        $('#new_wf').click(function() {
            var wf_order = parseInt($('#nav-tab a:last').text().slice(8)) + 1;
            var text1 = '<a class="nav-item nav-link" id="nav-wf-' + wf_order + '" data-toggle="tab" href="#nav-' + wf_order + '" role="tab" aria-controls="nav-' + wf_order + '" aria-selected="false">Workflow' + wf_order + '</a>';
            var text2 = '<div class="tab-pane fade" id="nav-' + wf_order + '" role="tabpanel" aria-labelledby="nav-wf-' + wf_order + '">' + wf_order + '</div>';
            $('#nav-tab').append(text1);
            $('#nav-tabContent').append(text2);
        });

        $('#del_wf').click(function() {
            var currentNode = $('div[id="nav-tab"]');

            if(currentNode.children().length == 1)
                return;

            var active_wf = $('#nav-tab a[aria-expanded="true"]');
            var active_order = parseInt(active_wf.text().slice(8));
            active_wf.remove();
            $('div[id="nav-' + active_order + '"]').remove();

            var node1 = currentNode.children('a:first-child');
            node1.attr('aria-expanded', 'true');
            node1.addClass('active');
            var node2 = $('#nav-tabContent div:first');
            node2.attr('aria-expanded', 'true');
            node2.addClass('active');
            node2.addClass('show');
            //currentNode.children('a:first-child').attr('aria-expanded', 'true');
        });
    }
</script>