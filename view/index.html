<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>数据流可视化分析平台</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="数据流可视化分析平台">
    <meta name="author" content="yzs">

    <link href="../public/css/bootstrap.min.css" rel="stylesheet">
    <link href="../public/css/font-awesome.min.css" rel="stylesheet">
    <link href="../public/css/jquery-ui.min.css" rel="stylesheet">
    <script src="../public/js/jquery.min.js"></script>
    <script src="../public/js/popper.min.js"></script>
    <script src="../public/js/bootstrap.min.js"></script>
    <script src="../public/js/jquery-ui.min.js"></script>
    <script src="../public/js/d3.min.js"></script>
    <script src="../public/js/d3-transform.min.js"></script>
    <script src="../public/js/vue.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../public/custom/index/index.css">
    <link rel="stylesheet" type="text/css" href="../public/custom/node/node.css">
    <link rel="stylesheet" type="text/css" href="../public/custom/charts/cluster.css">
    <link rel="stylesheet" type="text/css" href="../public/custom/cmd/cmd.css">
</head>
<body>
<div id="vm">
    <div id="header">
        <span class="logo">
            <img src="./public/node-red.png" title="0.19.5">
            <span>数据流可视化分析平台</span>
        </span>
        <ul class="header-toolbar hide" style="display: block;">
            <li style="display: none;">
                <a id="btn-notifications" class="button" href="#">
                    <i class="fa fa-warning"></i>
                </a>
            </li>
            <li>
                <span class="deploy-button-group button-group">
                    <a id="btn-deploy" class="deploy-button" @click="deployWorkflow">
                        <span class="deploy-button-content" style="opacity: 1;">
                            <img id="btn-deploy-icon" src="./public/deploy-full-o.png">
                            <span>Deploy</span>
                        </span>
                        <span class="deploy-button-spinner hide" style="display: none;">
                            <img src="./public/spin.svg">
                        </span>
                    </a>
                </span>
            </li>
            <li>
                <span class="deploy-button-group button-group">
                    <a id="btn-run" class="run-button" @click="runWorkflow">
                        <span class="deploy-button-content" style="opacity: 1;">
                            <i class="fa fa-play-circle" aria-hidden="true"></i>
                            <span>Run</span>
                        </span>
                        <span class="deploy-button-spinner hide" style="display: none;">
                            <img src="./public/spin.svg"></span>
                    </a>
                </span>
            </li>
            <li>
                <span class="deploy-button-group button-group">
                    <a id="btn-logout" class="run-button" @click="logout">
                        <span class="deploy-button-content" style="opacity: 1;">
                            <i class="fa fa-play-circle" aria-hidden="true"></i>
                            <span>logout</span>
                        </span>
                        <span class="deploy-button-spinner hide" style="display: none;">
                            <img src="./public/spin.svg"></span>
                    </a>
                </span>
            </li>

            <li>
                <span class="deploy-button-group button-group">
                    <a id="btn-refresh" class="run-button" @click="cleanCache">
                        <span class="deploy-button-content" style="opacity: 1;">
                            <i class="fa fa-play-circle" aria-hidden="true"></i>
                            <span>refresh</span>
                        </span>
                        <span class="deploy-button-spinner hide" style="display: none;">
                            <img src="./public/spin.svg"></span>
                    </a>
                </span>
            </li>
            <!--<li>-->
            <!--<a class="btn btn-link" href="#"><i class="fa fa-play-circle-o" aria-hidden="true"></i>&nbsp;运行</a>-->
            <!--</li>-->
            <!--<a class="btn btn-link" href="#"><i class="fa fa-cloud-upload" aria-hidden="true"></i>&nbsp;部署</a>-->
            <!--<a class="btn btn-link" href="#"><i class="fa fa-share-alt" aria-hidden="true"></i>&nbsp;分享</a>-->
        </ul>
        <div id="header-shade" class="hide" style="display: none;"></div>
    </div>
    <div id="main-container">
        <!-- 动态加载工作流组件 -->
        <div class="left-wrapper" id="palette">
            <img src="../public/images/spin.svg" class="node-spinner hide" style="display: none;">
            <div id="node-search" class="node-search">
                <div class="searchBox-container">
                    <i class="fa fa-search"></i>
                    <input type="text" data-i18n="[placeholder]node.filter" placeholder="filter nodes">
                    <a href="#"><i class="fa fa-times"></i></a>
                    <span class="searchBox-resultCount hide"></span>
                </div>
            </div>
            <div id="node-container" class="node-scroll">
                <template v-for="(module, key) in nodeCategory">
                    <div :id="'node-container-' + key" class="node-category"
                         style="display: block;">
                        <div :id="'component-header-' + key" class="component-header">
                            <i class="expanded fa fa-angle-down"></i>
                            <span>{{module['display'][lang]}}</span>
                        </div>
                        <div class="component-content" :id="'node-base-category-'+key" style="">
                            <template v-for="(info, key) in module">
                                <template v-if="key=='nodes'">
                                    <template v-for="(node, key) in info">
                                        <div class="node" :data-template-name="key"
                                             style="background-color: #fff; height: 30px">
                                            <div class="node_label" dir="">{{node[lang]}}</div>
                                            <div class="node_icon_container">
                                                <div class="node_icon"
                                                     :style="'background-image: url(../public/images/'+node+'.png)'"></div>
                                            </div>

                                            <template v-if="node['out'] != 0">
                                                <div class="node_port node_port_output" style="top: -48px;"></div>
                                            </template>
                                            <template v-if="node['in'] != 0">
                                                <div class="node_port node_port_input"
                                                     :style="node['out'] != 0 ? 'top: -58px;' : 'top: -48px;'"></div>
                                            </template>
                                        </div>
                                    </template>
                                </template>
                                <template v-else-if="key=='sub_modules'">
                                    <template v-for="(subModule, subModuleName) in info">
                                        <div :id="'node-sub-header-' + subModuleName"
                                             class="component-header node-sub-header">
                                            <i class="fa fa-plus-circle" aria-hidden="true"></i>
                                            <span>{{subModule['display'][lang]}}</span>
                                        </div>
                                        <div class="component-content node-sub-content"
                                             :id="'node-sub-category-'+subModuleName" style="">
                                            <div v-for="(node, nodeName) in subModule['nodes']" class="node-sub-content"
                                                 :id="'node-sub-content-'+subModuleName"
                                                 :data-content-id="'node-sub-header-' + subModuleName">
                                                <div class="node" :data-template-name="nodeName"
                                                     style="background-color: #fff; height: 30px;">
                                                    <div class="node_label" dir="">{{node[lang]}}</div>
                                                    <div class="node_icon_container">
                                                        <div class="node_icon"
                                                             :style="'background-image: url(../public/images/'+node+'.png)'"></div>
                                                    </div>
                                                    <template v-if="node['out'] != 0">
                                                        <div class="node_port node_port_output"
                                                             style="top: -48px;"></div>
                                                    </template>
                                                    <template v-if="node['in'] != 0">
                                                        <div class="node_port node_port_input"
                                                             style="top: -58px;"></div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
            <div id="node-footer">
                <a class="node-button" id="node-collapse-all" href="#"><i
                        class="fa fa-angle-double-up"></i></a>
                <a class="node-button" id="node-expand-all" href="#"><i
                        class="fa fa-angle-double-down"></i></a>
            </div>
            <div id="node-shade" class="hide"></div>
        </div>
        <!-- 工作空间 -->
        <div class="middle-wrapper" id="workspace">
            <!-- 工作流 -->
            <div id="workflow" class="workflow" style="position: absolute; width: 100%; height: 45%; top:0;">
                <div class="red-ui-tabs red-ui-tabs-add red-ui-tabs-scrollable" style="display: block;z-index: 0;">
                    <div class="red-ui-tabs-scroll-container">
                        <ul id="workspace-tabs" style="width: 100%;" class="">
                            <template v-for="(flow, index) in flows">
                                <li :class="['red-ui-tab ui-draggable', flow.id==currentFlow ? 'active' : '']"
                                    :id="'red-ui-tab-'+flow.id" style="width: 100%;">
                                    <a href="#" class="red-ui-tab-label" :title="flow.label"
                                       @click="changeWorkflow(flow.id)" @dblclick="configComponent(flow.id, flow.type)">
                                        <template v-if="flow.disabled">
                                            <span class="workspace-disabled-icon">
                                                <i class="fa fa-ban"></i>
                                            </span>
                                        </template>
                                        <span class="bidiAware" dir="#">{{flow.label}}</span>
                                    </a>
                                </li>
                            </template>
                        </ul>
                    </div>
                    <div class="red-ui-tab-button" id="workflow-add" @click="addWorkflow">
                        <a href="#"><i class="fa fa-plus"></i></a>
                    </div>
                    <div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left">
                        <a href="#" style="display: none;">
                            <i class="fa fa-caret-left"></i>
                        </a>
                    </div>
                    <div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right">
                        <a href="#" style="display: none;">
                            <i class="fa fa-caret-right"></i>
                        </a>
                    </div>
                </div>
                <div id="workflow-editor">
                    <!--<div class="btn-toolbar justify-content-between" role="toolbar" style="float: right; margin: 5px;">-->
                    <!--<div class="btn-group btn-group-sm" role="group" aria-label="First group">-->
                    <!--<button type="button" class="btn min" onclick="minScreen('workflow')" style="display: none;">-->
                    <!--<i class="fa fa-minus" aria-hidden="true"></i>-->
                    <!--</button>-->
                    <!--<button type="button" class="btn max" onclick="maxScreen('workflow')">-->
                    <!--<i class="fa fa-window-maximize" aria-hidden="true"></i>-->
                    <!--</button>-->
                    <!--</div>-->
                    <!--</div>-->
                    <svg width="5000" height="5000" pointer-events="all" style="position:relative;z-index: 0;"></svg>
                </div>
                <div id="workspace-footer">
                    <a class="workspace-footer-button" id="btn-zoom-out" href="#" style="display: inline-block;">
                        <i class="fa fa-minus"></i>
                    </a>
                    <a class="workspace-footer-button" id="btn-zoom-zero" href="#" style="display: inline-block;">
                        <i class="fa fa-circle-o"></i>
                    </a>
                    <a class="workspace-footer-button" id="btn-zoom-in" href="#" style="display: inline-block;">
                        <i class="fa fa-plus"></i></a>
                    <a class="workspace-footer-button-toggle single" id="btn-navigate" href="#"
                       style="display: inline-block;">
                        <i class="fa fa-map-o"></i>
                    </a>
                </div>
            </div>
            <!-- 可视化部分 -->
            <div id="visual" class="visual" style="position: absolute; width: 100%; height: 45%; top:45%;">
                <div class="btn-toolbar justify-content-between" role="toolbar" style="float: right;">
                    <div class="tab-title"><span>可视化</span></div>
                    <div class="btn-group btn-group-sm" role="group" aria-label="First group">
                        <button type="button" class="btn min" onclick="minScreen('visual')" style="display: none;">
                            <i class="fa fa-minus" aria-hidden="true"></i>
                        </button>
                        <button type="button" class="btn max" onclick="maxScreen('visual')">
                            <i class="fa fa-window-maximize" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                <div id="chart">
                    <div class="visual-chart" id="data-load"></div>
                    <div class="visual-chart" id="abnormalChart"></div>
                    <div class="visual-chart" id="cluster"></div>
                    <div class="visual-chart" id="motifArea">
                        <div id="motifChart"></div>

                        <div id="motifList" class="motifList">
                            <table id="motifTable" style="border:2px solid #d0d8e2;"></table>
                        </div>

                        <div id="subMotifChart"></div>
                    </div>

                </div>
            </div>

            <!-- 命令行部分 -->
            <div id="command" class="command" style="position: absolute; width: 100%; height: 10%; top:90%;">
                <div class="btn-toolbar justify-content-between" role="toolbar" style="float: right;">
                    <div class="tab-title"><span>命令行</span></div>
                    <div class="btn-group btn-group-sm" role="group" aria-label="First group">
                        <button type="button" class="btn min" onclick="minScreen('command')" style="display: none;">
                            <i class="fa fa-minus" aria-hidden="true"></i>
                        </button>
                        <button type="button" class="btn max" onclick="maxScreen('command')">
                            <i class="fa fa-window-maximize" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                <div id="cmd-shell">
                    <div class="shell-view">
                        <span class="prompt">$</span>
                        <span class="input">
                            <span class="left"></span>
                            <span class="cursor"></span>
                            <span class="right"></span>
                        </span>
                    </div>
                </div>
            </div>

            <div id="workflow-separator" class="ui-draggable separator"></div>
            <div id="visual-separator" class="ui-draggable separator"></div>
        </div>
        <!-- 信息栏 -->
        <div class="right-wrapper" id="sidebar">
            <div class="red-ui-tabs red-ui-tabs-collapsible">
                <div>
                    <ul id="sidebar-tabs">
                        <li class="red-ui-tab red-ui-tab-pinned active" id="red-ui-tab-info" style="width: 125px;">
                            <a href="#info" class="red-ui-tab-label" title="info">
                                <i class="red-ui-tab-icon fa fa-info"></i>
                                <span class="bidiAware" dir="">info</span>
                            </a>
                        </li>
                        <li class="red-ui-tab red-ui-tab-pinned" id="red-ui-tab-status" style="width: 125px;">
                            <a href="#status" class="red-ui-tab-label" title="status">
                                <i class="red-ui-tab-icon fa fa-cog"></i>
                                <span class="bidiAware" dir="">status</span>
                            </a>
                        </li>
                        <li class="red-ui-tab red-ui-tab-pinned" id="red-ui-tab-variable-space" style="width: 125px;">
                            <a href="#variable-space" class="red-ui-tab-label" title="variable-space">
                                <i class="red-ui-tab-icon fa fa-database"></i>
                                <span class="bidiAware" dir="">variable-space</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="red-ui-tab-link-buttons">
                    <a href="javascript:void(0);"
                       class="red-ui-tab-link-button red-ui-tab-link-button-pinned active selected"
                       id="red-ui-tab-info-link-button" @click="changeTab('info')">
                        <i class="fa fa-info"></i>
                    </a>
                    <a href="javascript:void(0);" class="red-ui-tab-link-button" id="red-ui-tab-status-link-button"
                       style="display: inline-block;" @click="changeTab('status')">
                        <i class="fa fa-cog"></i>
                    </a>
                    <a href="javascript:void(0);" class="red-ui-tab-link-button red-ui-tab-link-button-pinned"
                       id="red-ui-tab-variable-space-link-button" @click="changeTab('variable-space')">
                        <i class="fa fa-database"></i>
                    </a>
                </div>
            </div>
            <div id="sidebar-content">
                <div style="height: 100%; display: block;">
                    <div class="sidebar-info">
                        <!-- component info -->
                        <template v-if="component.id != ''">
                            <div :id="'sidebar-info-'+component.id">
                                <div class="component-header" :id="'component-header-params-'+component.id">
                                    <i class="fa fa-angle-down expanded"></i>
                                    <span>information</span>
                                </div>
                                <div :id="'node-params-'+component.id" class="component-content">
                                    <div style="position: relative; display: block;">
                                        <table class="node-info">
                                            <thead>
                                            <tr>
                                                <td>name</td>
                                                <td>value</td>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <template v-if="component.params.length != 0">
                                                <template v-for="(model, index) in component.params">
                                                    <tr class="node-info-node-row">
                                                        <td>{{model.label[lang]}}</td>
                                                        <template v-if="model.type=='file'">
                                                            <td>{{model.default.name}}</td>
                                                        </template>
                                                        <template v-else>
                                                            <td>{{model.default}}</td>
                                                        </template>
                                                    </tr>
                                                </template>
                                            </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div :id="'sidebar-description-'+component.id">
                                <div class="component-header" :id="'component-header-description-'+component.id">
                                    <i class="fa fa-angle-down expanded"></i>
                                    <span>description</span>
                                </div>
                                <div :id="'node-description-'+component.id" class="component-content">
                                    <div style="position: relative; display: block;">
                                        {{component.description}}
                                    </div>
                                </div>
                            </div>
                        </template>

                    </div>
                </div>
                <div style="height: 100%; display: none;">
                </div>
                <div style="height: 100%; display: none;">
                    <div class="sidebar-variable-space">
                        <!--<template v-if="flow.id != ''">-->
                        <template v-for="(flow, index) in variableSpace">
                            <div class="component-header" :id="'variable-header-'+index">
                                <i class="fa fa-angle-down expanded"></i>
                                <span :class="'flow-'+index">{{flows[index].label}}</span>
                            </div>

                            <div :id="'variable-space-flow-'+index" class="component-content">
                                <div style="position: relative; display: block;">
                                    <table class="node-info">
                                        <thead>
                                        <tr>
                                            <td>name</td>
                                            <td>size</td>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <template v-for="n in flow">
                                            <tr :class="['node-info-node-row', node.id == n.id ? 'active' : '']">
                                                <td>{{n.name}}</td>
                                                <td>{{n.size}}</td>
                                            </tr>
                                        </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </template>
                        <!--</template>-->
                    </div>
                </div>
            </div>
            <div id="sidebar-footer">
                <div style="display: none;">
                    <a class="sidebar-footer-button" id="workspace-config-node-collapse-all" href="#">
                        <i class="fa fa-angle-double-up"></i>
                    </a>
                    <a class="sidebar-footer-button" id="workspace-config-node-expand-all" href="#">
                        <i class="fa fa-angle-double-down"></i>
                    </a>
                </div>
                <div style="display: block;"></div>
                <div style="display: none;">
                    <span class="button-group">
                        <a id="debug-tab-open" class="sidebar-footer-button" href="#"
                           data-i18n="[title]node-red:debug.sidebar.openWindow" title="open in new window">
                            <i class="fa fa-desktop"></i>
                        </a>
                    </span>
                </div>
            </div>
            <div id="sidebar-shade" class="hide"></div>
        </div>
        <div id="sidebar-separator" class="ui-draggable"></div>
    </div>
    <div class="modal fade" id="configModal" tabindex="-1" role="dialog" aria-labelledby="configModalHeader"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <template v-if="component.id != ''">
                    <div class="modal-header">
                        <h5 class="modal-title" id="configModalHeader">{{component.name}}</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form method="post" id="main-form">
                            <template v-if="component.params.length != 0">
                                <template v-for="(model, index) in component.params">
                                    <div class="form-group">
                                        <label :for="model.name" class="col-sm-3">{{model.label[lang]}}</label>
                                        <template v-if="model.type == 'list'">
                                            <select :name="model.name" class="col-sm-8" v-model="model.default">
                                                <option value="">全部</option>
                                                <template v-for="(option, id) in model.list">
                                                    <option :value="option"
                                                            :selected="model.default == id || model.default == option">
                                                        {{option}}
                                                    </option>
                                                </template>
                                            </select>
                                        </template>
                                        <template v-else-if="model.type == 'richtext'">
                                        <textarea :type="model.type" class="col-sm-8" :name="model.name"
                                                  :placeholder="model.default"
                                                  v-model="model.default">{{model.default}}</textarea>
                                        </template>
                                        <template v-else-if="model.type == 'file'">
                                            <a href="javascript:;" class="file-upload">
                                                <span v-if="model.default==''">选择文件</span>
                                                <span v-else>更改文件</span>
                                                <input :id="'file_'+node.id" :type="model.type" class="col-sm-8"
                                                       :name="model.name"
                                                       :placeholder="model.default"
                                                       accept="text/csv" @change="getFile($event)">
                                            </a>
                                            <span class="file-upload-path">{{model.default.name}}</span>
                                        </template>
                                        <template v-else>
                                            <input :type="model.type" class="col-sm-8" :name="model.name"
                                                   :placeholder="model.default" :value="model.default"
                                                   v-model="model.default">
                                        </template>
                                    </div>
                                </template>

                            </template>
                            <template v-else>
                                <div class="form-group">
                                    抱歉，暂时不可配置～
                                </div>
                            </template>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-warning" @click="deleteComponent()">删除</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" @click="saveComponentConfig()">确定</button>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>
</body>
</html>
<script>
    var env = 'debug';
</script>

<script src="../config/config.min.js"></script>
<!--<script src="../config/config.js"></script>-->
<script src="../public/custom/node/node.js"></script>
<script src="../public/custom/index/index.js"></script>
<script src="../public/custom/charts/charts.js"></script>
<script src="../public/custom/charts/cluster.js"></script>
<script src="../public/custom/charts/motif.js"></script>
<script src="../public/custom/cmd/cmd.js"></script>
<script src="../public/js/cookie.js"></script>
<script src="../public/custom/webSocket/webSocket.js"></script>
<script>
    //vue 绑定
    var vm = new Vue({
        el: '#vm',
        data: {
            initFinish: false,
            nodeCategory: {},
            flows: {},
            nodes:{},
            component: {
                id: "",
                name: "",
                type: "",
                params: [],
                description: "",
            },
            node: {
                id: "",
                name: "",
                type: "",
                params: [],
                description: "",
            },
            flow: {
                id: "",
                label: "",
                disabled: null,
                description: "",
            },
            path: {
                id: "",
                from: "",
                to: ""
            },
            currentFlow: 0,
            routers: {},
            variableSpace: {},
            uploadFile: false,
            lang: getCookieValue("lang"),
        },
        mounted: function () {
            // 工作流初始化
            $(function () {
                // 获取token
                workflow.token = getCookieValue("token");
                console.log("token: ", workflow.token);
                if (workflow.token == "" || workflow.token == undefined) {
                    //window.location.href = 'login.html';
                }

                // 默认有一个flow
                vm.loadWorkflow();

                // 初始化左侧组件栏
                vm.nodeCategory = node_category;

                // 初始化系统语言
                if (vm.lang == "") {
                    vm.lang = 'zh';
                }

                // 键盘事件
                document.onkeydown = function () {
                    var oEvent = window.event;
                    if (oEvent.keyCode === 46) {
                        //逻辑处理
                        if (vm.component.id != "") {
                            onComponentDelete(vm.component.id, vm.component.type);
                            vm.enableA('#btn-deploy');
                            update();
                        }
                        if (vm.path.id != "") {
                            onPathDelete(vm.path.id);
                            vm.enableA('#btn-deploy');
                            update();
                        }
                    }
                };

                // separator事件
                separator();
            });
        },
        updated: function () {
            // 初始化node拖拽
            if (!vm.initFinish) {  // 确保只初始化一次
                init();
                vm.initFinish = true;
            }

            // 绑定节点列表事件
            $('.component-header').unbind().click(function () {
                var id = $(this).attr('id');
                var nextId = $(this).next().attr('id');
                var el_i = $('#' + id + ' >i');
                el_i.toggleClass('expanded');
                var nextEl = $('#' + nextId);
                nextEl.slideToggle(500);
            });
            $('#node-collapse-all').unbind().click(function (e) {
                var container = $('#node-container');
                container.find('.component-header > i').removeClass('expanded');
                container.find('.component-content').slideUp(500);
            });

            $('#node-expand-all').unbind().click(function (e) {
                var container = $('#node-container');
                container.find('.component-header > i').addClass('expanded');
                container.find('.component-content').slideDown(500);
            });
        },
        methods: {
            // 加载工作流
            loadWorkflow: function () {
                console.log('loading');
                $.ajax({
                    url: api_map.workflow_load,
                    type: 'POST',
                    data: {
                        token: workflow.token
                    },
                    dataType: 'json',
                    success: function (res) {
                        if (res.code == 0) {
                            // 更新工作流
                            vm.updateWorkflow(res.data.workflow);
                            console.log('loaded');
                        } else {
                            //console.log("用户不存在，请注册！");
                            //window.location.href = 'login.html';
                            // todo
                            // 新建默认工作流
                            vm.addWorkflow();
                        }
                    }
                });
            },
            deployWorkflow: function () {
                // 工作流无节点，返回false
                if (vm.flows[vm.currentFlow].nodes.length == 0) {
                    alert("工作流无节点！");
                    return false;
                }
                // 发送工作流
                $.ajax({
                    url: api_map.workflow_deploy + "?type=0",
                    type: 'POST',
                    data: JSON.stringify(workflow),
                    contentType: 'application/json',
                    beforeSend: function () {
                        console.log('before deploy');
                        // 防止多次部署
                        vm.disabledA('#btn-deploy');
                    },
                    success: function (res) {
                        if (res.code == 0) {
                            workflow.token = res.data.token;
                            updateNodeStatus(res.data.status);
                        } else {
                            alert(res.msg);
                        }
                    },
                    complete: function () {
                        console.log('deploy complete');
                        vm.enableA('#btn-deploy');
                    },
                    error: function (res) {
                        alert('啊哦，服务器连接失败了～');
                    }
                });
            },
            saveWorkflow: function () {
                $.ajax({
                    url: api_map.workflow_save,
                    type: 'POST',
                    data: JSON.stringify(workflow),
                    contentType: 'application/json',
                    success: function (res) {
                        if (res.code == 0) {
                            console.log("工作流保存成功");
                        } else {
                            console.log("工作流保存失败");
                        }
                    }
                });
            },
            runWorkflow: function () {
                // 如果无节点，返回false
                if (vm.flows[vm.currentFlow].nodes.length == 0) {
                    alert("工作流无节点！");
                    return false;
                }

                for (let nodeId in vm.flows[vm.currentFlow].nodes) {
                    // 如果状态正确，显示启动
                    if(!vm.checkNodeStatus(nodeId)){
                        return false;
                    }
                }

                if(vm.checkUploadFile()){
                    $.ajax({
                        url: api_map.workflow_run,
                        type: 'POST',
                        data: {
                            token: workflow.token,
                            flowId: vm.currentFlow
                        },
                        dataType: 'json',
                        beforeSend: function () {
                            for (let nodeId in vm.flows[vm.currentFlow].nodes) {
                                vm.onNodeRun(nodeId);
                            }
                            vm.disabledA('#btn-run');
                        },
                        success: function (res) {
                            if (res.code == 0) {
                                console.log("节点们正在运行。。。");
                                return true;
                            } else {
                                alert(res.msg);
                                let nodeStatus = {};
                                for (let nodeId in vm.routers) {
                                    nodeStatus[nodeId] = res.code;
                                }
                                updateNodeStatus(nodeStatus);
                                return false;
                            }
                        },
                        complete: function () {
                            vm.enableA('#btn-run');
                        }
                    });
                }
            },
            addWorkflow: function () {
                if (!workflow.used.flow) {
                    workflow.used.flow = 0;
                }
                let flowId = parseInt(workflow.used.flow) + 1;  // 暂时使用自增
                // 重构代码
                workflow.used.flow += 1;
                if (workflow.task[flowId]) {
                    console.error("工作流id重复！");
                    return;
                }
                workflow.task[flowId] = {
                    id: flowId,
                    type: "flow",
                    label: "Flow " + flowId,
                    disabled: false,
                    description: "这是一个新flow",
                    nodes: []
                };
                // 重构代码
                vm.flows[flowId] = workflow.task[flowId];

                // 切换工作流
                vm.changeWorkflow(flowId, true);

                // 保存工作流
                //vm.saveWorkflow();
            },
            changeWorkflow: function (flowId, force = false) {
                // 记录上一flow
                let lastFlowId = vm.currentFlow;
                // 如果点击同一个flow，忽略该事件
                if (lastFlowId == flowId && !force) {
                    console.log("重复点击，该操作无效");
                    return;
                }
                // 更新当前flow
                vm.currentFlow = parseInt(flowId);
                update();
                // 清除上一flow的节点
                hideNodesByFlow(lastFlowId);
                // 添加当前flow的节点
                showNodesByFlow(flowId);
                // todo
                // 记录每个workflow的状态，根据状态进行部署
                vm.enableA('#btn-deploy');
            },
            updateWorkflow: function (data) {
                // 如果工作流为空，则增加默认的工作流任务栏
                if (data == "" || data == null || JSON.stringify(data) == "{}") {
                    vm.addWorkflow();
                    return;
                }
                vm.flows = {};
                vm.nodes = {};
                vm.variableSpace = {};

                // 更新工作流
                workflow = data;
                console.log(workflow);

                if (JSON.stringify(workflow.task) == '{}') {
                    vm.addWorkflow();
                    return;
                }

                // 获取任务栏即变量空间
                for(let id in workflow.task){
                    console.log(id);
                    if(!workflow.task[id]){
                        continue;
                    }
                    if(workflow.task[id].type == "flow"){
                        vm.flows[id] = workflow.task[id];
                        vm.variableSpace[id] = {};
                    } else{
                        vm.nodes[id] = workflow.task[id];
                        var flowId = vm.nodes[id].z;
                        vm.variableSpace[flowId][id] = {
                            id: id,
                            name: workflow.task[id].variable,
                            size: workflow.task[id].size
                        };
                    }
                }

                console.log(vm.variableSpace);

                // 显示第一个任务栏
                for (let flowId in vm.flows) {
                    vm.currentFlow = parseInt(flowId);
                    hideNodesByFlow(flowId);
                    showNodesByFlow(flowId);
                    vm.component = getComponent(vm.currentFlow, 'flow', vm.lang);
                    break;
                }
            },

            runNode: function (nodeId) {
                // 检查状态
                if (!vm.checkNodeStatus(nodeId)) {
                    return false;
                }
                // 显示启动
                this.onNodeRun(nodeId);
                // 发送请求
                $.ajax({
                    url: api_map.node_run,
                    type: 'POST',
                    data: {
                        token: workflow.token,
                        nodeId: nodeId
                    },
                    dataType: 'json',
                    success: function (res) {
                        if (res.code == 0) {

                        } else {
                            alert(res.msg);
                            let nodeStatus = {};
                            nodeStatus[nodeId] = res.code;
                            updateNodeStatus(nodeStatus);
                        }
                    }
                });
            },
            stopNode: function (nodeId) {
                this.onNodeStop(nodeId);
            },
            onNodeRun: function (nodeId) {
                $('#' + nodeId + ' .run')
                        .attr('onclick', 'stopNode(' + nodeId + ')')
                        .attr('fill', '#1aad19 !important')
                        .text('\uf04d');
            },
            onNodeStop: function (nodeId) {
                $('#' + nodeId + ' .run')
                        .attr('onclick', 'runNode(' + nodeId + ')')
                        .attr('fill', '#1aad19 !important')
                        .text('\uf04b');
            },
            onNodeReRun: function (nodeId) {
                $('#' + nodeId + ' .run')
                        .attr('onclick', 'runNode(' + nodeId + ')')
                        .attr('fill', '#1aad19 !important')
                        .text('\uf021');
            },
//            saveNodeConfig: function (nodeId) {
//                $('#configModal').modal('hide');
//                var data = $('#main-form').serializeArray();
//                var dataSetName = "-1";
//                var variable = "-1";  // -1 代表不需要变量
//                $.each(data, function () {
//                    workflow.task[nodeId][this.name] = this.value;
//                    console.log(this.name, this.value);
//                    if (this.name == "name") {
//                        dataSetName = this.value;
//                    }
//                    if (this.name == "variable") {
//                        variable = this.value;
//                    }
//                });
//                // 如果该组件需要上传文件并且是第一次或者修改文件路径时
//                if (this.uploadFile) {
//                    var nodeId = this.node.id;
//                    var filePath = $('#file_' + nodeId)[0].files[0];
//                    if (filePath == undefined || dataSetName == "") {
//                        console.log("error");
//                        return;
//                    }
//
//                    workflow.task[nodeId].path = filePath.name;
//
//                    vm.onNodeRun(nodeId);
//
//                    var flow = {};
//                    flow.token = workflow.token;
//
//                    var formData = new FormData();
//                    formData.append('file', filePath);
//                    formData.append('token', workflow.token);
//                    formData.append('nodeId', nodeId);
//                    formData.append('flowId', vm.currentFlow);
//                    formData.append('nodeType', vm.node.type);
//                    formData.append('dataSetName', dataSetName);
//                    $.ajax({
//                        url: api_map.upload,
//                        type: 'POST',
//                        data: formData,
//                        cache: false,    //上传文件不需缓存
//                        processData: false, //需设置为false。因为data值是FormData对象，不需要对数据做处理
//                        contentType: false, //需设置为false。因为是FormData对象，且已经声明了属性enctype="multipart/form-data"
//                        success: function (res) {
//                            if (res.code == 0) {
//                                updateNodeStatus(res.data.initResult);
//                            } else {
//                                vm.onNodeStop(nodeId);
//                                alert(res.msg);
//                            }
//                        }
//                    });
//                }
//
//                // 保存变量
//                if (variable != "-1") {
//                    vm.saveVariableConfig(variable);
//                }
//
//                // 更新节点参数
//                //vm.deployWorkflow();
//
//                // 显示节点属性
////                onNodeDetail(vm.node.id, true);
//                onComponentDetail(vm.component.id, vm.component.type, true);
//                vm.enableA('#btn-deploy');
//            },

            runCmd: function (cmd) {
                console.log(cmd);
                $.ajax({
                    url: api_map.cmd_run,
                    type: 'POST',
                    data: {
                        token: workflow.token,
                        flowId: vm.currentFlow,
                        cmd: cmd,
                    },
                    dataType: "json",
                    success: function (res) {
                        if (res.code != 0) {
                            alert(res.msg);
                        }
                    },
                    error: function (e) {
                        console.log(e);
                    }
                });
            },

            configComponent: function (id, type) {
                onComponentDetail(id, type, true);
                onComponentConfig();
            },
            saveComponentConfig: function () {
                console.log('save config');
                $('#configModal').modal('hide');
                onComponentConfigSave();
            },
            deleteComponent: function () {
                onComponentDelete(vm.component.id, vm.component.type);
            },

            checkNodeStatus: function (nodeId) {
                // Check: 检测节点状态是否满足要求
                var node = $('#' + nodeId);
                var status = node.attr('status');
                if (status == 3 || status == 7) {
                    alert('状态不正确');
                    return false;
                }
                if (status == 4) {
                    console.log('run again');
                }
                return true;
            },

            checkUploadFile: function () {
                let nodes = vm.flows[vm.currentFlow].nodes;
                for(let i=0, len=nodes.length; i<len; i++){
                    let nodeId = nodes[i];
                    if(workflow.task[nodeId].type == 'data-upload'
                            && workflow.task[nodeId].path
                            && (workflow.task[nodeId].status == 1
                            || workflow.task[nodeId].status == 7)){
                        var formData = new FormData();
                        formData.append('token', workflow.token);
                        formData.append('flowId', vm.currentFlow);
                        formData.append('nodeId', nodeId);
                        formData.append('file', workflow.task[nodeId].path);
                        JSON.stringify(formData);
                        $.ajax({
                            url: api_map.upload,
                            type: 'POST',
                            data: formData,
                            cache: false,       //上传文件不需缓存
                            processData: false, //需设置为false。因为data值是FormData对象，不需要对数据做处理
                            contentType: false, //需设置为false。因为是FormData对象，且已经声明了属性enctype="multipart/form-data"
                            beforeSend: function () {
                                vm.onNodeRun(nodeId);
                            },
                            success: function (res) {
                                if (res.code == 0) {
                                    updateNodeStatus(res.data.status);
                                } else {
                                    alert(res.msg);
                                }
                            },
                            complete: function () {
                                vm.onNodeStop(nodeId);
                            }
                        });
                    }
                }
                return true;
            },
            saveVariableConfig: function (variable) {
                let request = {};
                request['token'] = workflow.token;
                request['flowId'] = vm.currentFlow;
                request['nodeId'] = vm.node.id;
                request['variableName'] = variable;
                request['size'] = "";
                let data = JSON.stringify(request);
                // 保存变量
                $.ajax({
                    url: api_map.variable_save,
                    type: 'POST',
                    data: data,
                    contentType: 'application/json',
                    success: function (res) {
                        if (res.code == 0) {

                        } else {
                            alert(res.msg);
                        }
                    },
                    error: function (res) {
                        alert('变量保存失败！');
                    }
                });

                // 更新本地
                if (!vm.variableSpace[vm.currentFlow]) {
                    vm.variableSpace[vm.currentFlow] = {
                        id: vm.currentFlow,
                        type: vm.flow.type,
                        label: vm.flow.label,
                        disabled: vm.flow.disabled,
                        description: vm.flow.description,
                        nodes: {}
                    };
                }
                if (!vm.variableSpace[vm.currentFlow].nodes[vm.node.id]) {
                    vm.variableSpace[vm.currentFlow].nodes[vm.node.id] = {
                        id: vm.node.id,
                        name: variable,
                        size: ""
                    }
                }
                vm.variableSpace[vm.currentFlow].nodes[vm.node.id].name = variable;
            },
            loadVariableConfig: function () {
                let request = {};
                request['token'] = workflow.token;
                request['flowId'] = vm.currentFlow;
                request['nodeId'] = vm.node.id;
                let data = JSON.stringify(request);
                JSON.stringify(data);
                $.ajax({
                    url: api_map.variable_load,
                    type: 'POST',
                    data: data,
                    contentType: 'application/json',
                    success: function (res) {
                        if (res.code == 0) {
                            for (let i = 0, len = res.data.length; i < len; i++) {
                                let fId = res.data[i].flowId;
                                let nId = res.data[i].nodeId;
                                vm.variableSpace[fId].nodes[nId].name = res.data[i].variableName;
                                vm.variableSpace[fId].nodes[nId].size = res.data[i].size;
                            }
                        } else {
                            alert(res.msg);
                        }
                    },
                    error: function (res) {
                        alert('加载变量失败！');
                    }
                });
            },
            changeTab: function (tab) {
                $('.red-ui-tab-link-buttons a').removeClass('active selected');
                $('#sidebar-content > div').css({display: 'none'});
                $('#sidebar-tabs li').removeClass('active');
                var div = $('.sidebar-' + tab);
                div.parent().css({display: 'block'});

                $('#red-ui-tab-' + tab + '-link-button').addClass('active selected');
                $('#sidebar-tabs #red-ui-tab-' + tab).addClass('active');
            },
            disabledA: function (selector) {
                let ele = $(selector);
                ele.addClass('disabled');
                ele.css("pointer-events", "none");
            },
            enableA: function (selector) {
                let ele = $(selector);
                ele.removeClass('disabled');
                ele.css("pointer-events", "");
            },

            logout: function () {
                // 保存当前工作流
                vm.saveWorkflow();
                // 跳转至登陆界面
                window.location.href = 'login.html';
            },

            getFile(event) {
                let file = event.target.files[0];
                console.log(file);
                for (let i = 0, len = vm.component.params.length; i < len; i++) {
                    if(vm.component.params[i].name == 'path'){
                        vm.component.params[i].default = file;
                        $(".file-upload-path").html(file.name);
                        break;
                    }
                }
            },

            cleanCache: function () {
                $.ajax({
                    url: api_map.cache_clean,
                    type: 'POST',
                    data: {
                        token: workflow.token
                    },
                    dataType: 'json',
                    success: function (res) {
                        if (res.code == 0) {
                            console.log('缓存清除成功');
                            window.location.href = 'login.html';
                        } else {
                            alert(res.msg);
                        }
                    },
                    error: function (res) {
                        alert('缓存清除失败！');
                    }
                });
            },
            debug: function () {

            }
        }
    });

    // 更改语言
    function changLang() {
        if (vm.lang == 'en') {
            vm.lang = 'zh';
        } else {
            vm.lang = 'en';
        }
        setCookie('lang', vm.lang, 24, "/");
    }

    // 更新参数
    function update() {
        // 先重置各状态
        d3.selectAll('svg .node').attr('class', 'node');
        d3.selectAll('svg .cable').attr('class', 'cable');
        vm.component = {
            id: "",
            name: "",
            type: "",
            params: [],
            description: ""
        };
        vm.flow = {
            id: "",
            label: "",
            disabled: null,
            params: [],
            description: "",
        };
        vm.node = {
            id: "",
            name: "",
            type: "",
            params: [],
            description: ""
        };
        vm.path = {
            id: "",
            from: "",
            to: ""
        };
        vm.uploadFile = false;

        if(!workflow.task[vm.currentFlow]){
            console.error('flow' + vm.currentFlow + '不存在！');
            return;
        }

        // 更新组件
        vm.component = getComponent(vm.currentFlow, 'flow', vm.lang);
        // 更新各节点状态
        let nodesList = workflow.task[vm.currentFlow].nodes;
        for(let i=0, len=nodesList.length; i<len; i++){
            let nodeId = nodesList[i];
            d3.selectAll('g[id="' + nodeId + '"]')
                    .attr('class', 'node ' + node_status_map[workflow.task[nodeId].status]);
        }
    }

    // 可视化
    function visualize(data) {
        $('.visual-chart').attr('style', 'display:none');
        var op = data.op;
        console.log(data);
        switch (op) {
            case "data-upload":
            case "data-load":
            case "prehandle":
                console.log("data-load");
                $('#data-load').attr('style', 'display:block');
                showGraph(data.result);
                break;
            case "stl":
                console.log("stl");
                $('#abnormalChart').attr('style', 'display:block');
                abnormalVisual(data.result);
                break;
            case "motif":
                console.log("motif");
                $('#motifArea').attr('style', 'display:block');
                var motifData = generateMotifData(5);
                motifAreaVisual(motifData);
                break;
            case "cluster":
            case "sax-classify":
            case "fsh":
            case "elis":
            case "kshape":
                console.log("cluster");
                $('#cluster').attr('style', 'display:block');
                initCluster(data.result);
                break;
            default:
                console.log('default');
                break;
        }
    }

    // 上传文件
    function onUploadFileChange() {
        $(".file-upload").on("change", "input[type='file']", function () {
            var filePath = $(this).val();
            var arr = filePath.split('\\');
            var fileName = arr[arr.length - 1];
            $(".file-upload-path").html(fileName);
        });
    }
</script>
<script src="../public/js/echarts/echarts.js"></script>
<script src="../public/js/underscore-1.8.2.min.js"></script>