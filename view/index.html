<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>数据流可视化分析平台</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="数据流可视化分析平台">
    <meta name="author" content="yzs">

    <link href="../public/css/bootstrap.min.css" rel="stylesheet">
    <link href="../public/css/font-awesome.min.css" rel="stylesheet">
    <link href="../public/css/jquery-ui.min.css" rel="stylesheet">
    <script src="../public/js/jquery.min.js"></script>
    <script src="../public/js/popper.min.js"></script>
    <script src="../public/js/bootstrap.min.js"></script>
    <script src="../public/js/jquery-ui.min.js"></script>
    <script src="../public/js/d3.min.js"></script>
    <script src="../public/js/d3-transform.min.js"></script>
    <script src="../public/js/vue.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../public/custom/index/index.css">
    <link rel="stylesheet" type="text/css" href="../public/custom/node/node.css">
</head>
<body>
<div id="vm">
    <div id="header">
        <span class="logo">
            <img src="./public/node-red.png" title="0.19.5">
            <span>数据流可视化分析平台</span>
        </span>
        <ul class="header-toolbar hide" style="display: block;">
            <li style="display: none;">
                <a id="btn-notifications" class="button" href="#">
                    <i class="fa fa-warning"></i>
                </a>
            </li>
            <li>
                <span class="deploy-button-group button-group">
                    <a id="btn-deploy" class="deploy-button" @click="deploy">
                        <span class="deploy-button-content" style="opacity: 1;">
                            <img id="btn-deploy-icon" src="./public/deploy-full-o.png">
                            <span>Deploy</span>
                        </span>
                        <span class="deploy-button-spinner hide" style="display: none;"><img
                                src="./public/spin.svg"></span>
                    </a>
                </span>
            </li>
        </ul>
        <div id="header-shade" class="hide" style="display: none;"></div>
    </div>
    <div id="main-container">
        <!-- 动态加载工作流组件 -->
        <div class="left-wrapper" id="palette">
            <img src="../public/images/spin.svg" class="node-spinner hide" style="display: none;">
            <div id="node-search" class="node-search">
                <div class="searchBox-container">
                    <i class="fa fa-search"></i>
                    <input type="text" data-i18n="[placeholder]node.filter" placeholder="filter nodes">
                    <a href="#"><i class="fa fa-times"></i></a>
                    <span class="searchBox-resultCount hide"></span>
                </div>
            </div>
            <div id="node-container" class="node-scroll">
                <template v-for="(module, key) in nodes">
                    <div :id="'node-container-' + key" class="node-category node-close hide node-open"
                         style="display: block;">
                        <div class="node-content" :id="'node-base-category-'+key" style="">
                            <div :id="'node-header-' + key" class="node-header">
                                <i class="expanded fa fa-angle-down"></i>
                                <span>{{module['display'][lang]}}</span>
                            </div>
                            <div v-for="(info, key) in module">
                                <template v-if="key=='nodes'">
                                    <template v-for="(node, key) in info">
                                        <div class="node" :data-template-name="key"
                                             style="background-color: #fff; height: 30px">
                                            <div class="node_label" dir="">{{node[lang]}}</div>
                                            <div class="node_icon_container">
                                                <div class="node_icon"
                                                     :style="'background-image: url(../public/images/'+node+'.png)'"></div>
                                            </div>

                                            <template v-if="node['out'] != 0">
                                                <div class="node_port node_port_output" style="top: -48px;"></div>
                                            </template>
                                            <template v-if="node['in'] != 0">
                                                <div class="node_port node_port_input"
                                                     :style="node['out'] != 0 ? 'top: -58px;' : 'top: -48px;'"></div>
                                            </template>
                                        </div>
                                    </template>
                                </template>
                                <template v-else-if="key=='sub_modules'">
                                    <template v-for="module in info">
                                        <div :id="'node-header-' + key" class="node-header">
                                            <i class="fa fa-plus-circle" aria-hidden="true"></i>
                                            <span>{{module['display'][lang]}}</span>
                                        </div>
                                        <div v-for="(node, key) in module['nodes']">
                                            <div class="node" :data-template-name="key"
                                                 style="background-color: #fff; height: 30px;">
                                                <div class="node_label" dir="">{{node[lang]}}</div>
                                                <div class="node_icon_container">
                                                    <div class="node_icon"
                                                         :style="'background-image: url(../public/images/'+node+'.png)'"></div>
                                                </div>
                                                <template v-if="node['out'] != 0">
                                                    <div class="node_port node_port_output" style="top: -48px;"></div>
                                                </template>
                                                <template v-if="node['in'] != 0">
                                                    <div class="node_port node_port_input" style="top: -58px;"></div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            <div id="node-footer">
                <a class="node-button" id="node-collapse-all" href="#"><i
                        class="fa fa-angle-double-up"></i></a>
                <a class="node-button" id="node-expand-all" href="#"><i
                        class="fa fa-angle-double-down"></i></a>
            </div>
            <div id="node-shade" class="hide"></div>
        </div>
        <!-- 工作空间 -->
        <div class="middle-wrapper" id="workspace">
            <!-- 工作流 -->
            <div id="workflow" class="workflow" style="position: absolute; width: 100%; height: 45%; top:0;">
                <div class="red-ui-tabs red-ui-tabs-add red-ui-tabs-scrollable" style="display: block;z-index: 0;">
                    <div class="red-ui-tabs-scroll-container">
                        <ul id="workspace-tabs" style="width: 100%;" class="">
                            <li class="red-ui-tab ui-draggable active" id="red-ui-tab-fd9028d1-470fa8"
                                style="width: 100%;">
                                <a href="#" class="red-ui-tab-label" title="Flow 2">
                                    <span class="workspace-disabled-icon">
                                        <i class="fa fa-ban"></i>
                                    </span>
                                    <span class="bidiAware" dir="#">Flow 1</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="red-ui-tab-button"><a href="#"><i class="fa fa-plus"></i></a></div>
                    <div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left">
                        <a href="#" style="display: none;">
                            <i class="fa fa-caret-left"></i>
                        </a>
                    </div>
                    <div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right">
                        <a href="#" style="display: none;">
                            <i class="fa fa-caret-right"></i>
                        </a>
                    </div>
                </div>
                <div id="workflow-editor">
                    <!--<div class="btn-toolbar justify-content-between" role="toolbar" style="float: right; margin: 5px;">-->
                    <!--<div class="btn-group btn-group-sm" role="group" aria-label="First group">-->
                    <!--<button type="button" class="btn" onclick="minScreen('workflow')" style="display: none;">-->
                    <!--<i class="fa fa-minus" aria-hidden="true"></i>-->
                    <!--</button>-->
                    <!--<button type="button" class="btn" onclick="maxScreen('workflow')">-->
                    <!--<i class="fa fa-window-maximize" aria-hidden="true"></i>-->
                    <!--</button>-->
                    <!--</div>-->
                    <!--</div>-->
                    <svg width="5000" height="5000" pointer-events="all" style="position:relative;z-index: 0;"></svg>
                </div>
                <div id="workspace-footer">
                    <a class="workspace-footer-button" id="btn-zoom-out" href="#" style="display: inline-block;">
                        <i class="fa fa-minus"></i>
                    </a>
                    <a class="workspace-footer-button" id="btn-zoom-zero" href="#" style="display: inline-block;">
                        <i class="fa fa-circle-o"></i>
                    </a>
                    <a class="workspace-footer-button" id="btn-zoom-in" href="#" style="display: inline-block;">
                        <i class="fa fa-plus"></i></a>
                    <a class="workspace-footer-button-toggle single" id="btn-navigate" href="#"
                       style="display: inline-block;">
                        <i class="fa fa-map-o"></i>
                    </a>
                </div>
            </div>
            <!-- 可视化部分 -->
            <div id="visual" class="visual" style="position: absolute; width: 100%; height: 45%; top:45%;">
                <div class="btn-toolbar justify-content-between" role="toolbar" style="float: right; margin: 5px">
                    <div class="btn-group btn-group-sm" role="group" aria-label="First group">
                        <button type="button" class="btn" onclick="minScreen('visual')" style="display: none;">
                            <i class="fa fa-minus" aria-hidden="true"></i>
                        </button>
                        <button type="button" class="btn" onclick="maxScreen('visual')">
                            <i class="fa fa-window-maximize" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                <div id="chart">
                    <div class="visual-chart" id="data-load"></div>
                    <div class="visual-chart" id="abnormalChart"></div>
                    <div class="visual-chart" id="motifChart"></div>
                    <div class="visual-chart" id="cluster"></div>
                </div>
            </div>

            <!-- 命令行部分 -->
            <div id="command" class="command" style="position: absolute; width: 100%; height: 10%; top:90%;">
                <div class="btn-toolbar justify-content-between" role="toolbar" style="float: right; margin: 5px">
                    <div class="btn-group btn-group-sm" role="group" aria-label="First group">
                        <button type="button" class="btn" onclick="minScreen('command')" style="display: none;">
                            <i class="fa fa-minus" aria-hidden="true"></i>
                        </button>
                        <button type="button" class="btn" onclick="maxScreen('command')">
                            <i class="fa fa-window-maximize" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 20px">
                    <label class="input-group-addon">In[1]</label>
                    <input type="text" class="form-control" aria-label="Recipient's username"
                           aria-describedby="basic-addon2">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button">Submit</button>
                    </div>
                </div>
            </div>

            <div id="workflow-separator" class="ui-draggable separator"></div>
            <div id="visual-separator" class="ui-draggable separator"></div>
        </div>
        <!-- 信息栏 -->
        <div class="right-wrapper" id="sidebar">
            <!--<button type="button" class="btn btn-primary" onclick="debug()"></button>-->
            <!--<input id="text" type="text"/>-->
            <!--<button onclick="send()">Send</button>-->
            <!--<button onclick="closeWebSocket()">Close</button>-->
            <div class="red-ui-tabs red-ui-tabs-collapsible">
                <div>
                    <ul id="sidebar-tabs">
                        <li class="red-ui-tab red-ui-tab-pinned active" id="red-ui-tab-info" style="width: 125px;">
                            <a href="#info" class="red-ui-tab-label" title="info">
                                <i class="red-ui-tab-icon fa fa-info"></i>
                                <span class="bidiAware" dir="">info</span>
                            </a>
                        </li>
                        <li class="red-ui-tab red-ui-tab-pinned" id="red-ui-tab-status" style="width: 125px;">
                            <a href="#status" class="red-ui-tab-label" title="status">
                                <i class="red-ui-tab-icon fa fa-cog"></i>
                                <span class="bidiAware" dir="">status</span>
                            </a>
                        </li>
                        <li class="red-ui-tab red-ui-tab-pinned" id="red-ui-tab-variable-space" style="width: 125px;">
                            <a href="#variable-space" class="red-ui-tab-label" title="variable-space">
                                <i class="red-ui-tab-icon fa fa-database"></i>
                                <span class="bidiAware" dir="">variable-space</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="red-ui-tab-link-buttons">
                    <a href="javascript:void(0);"
                       class="red-ui-tab-link-button red-ui-tab-link-button-pinned active selected"
                       id="red-ui-tab-info-link-button" @click="changeTab('info')">
                        <i class="fa fa-info"></i>
                    </a>
                    <a href="javascript:void(0);" class="red-ui-tab-link-button" id="red-ui-tab-status-link-button"
                       style="display: inline-block;" @click="changeTab('status')">
                        <i class="fa fa-cog"></i>
                    </a>
                    <a href="javascript:void(0);" class="red-ui-tab-link-button red-ui-tab-link-button-pinned"
                       id="red-ui-tab-variable-space-link-button" @click="changeTab('variable-space')">
                        <i class="fa fa-database"></i>
                    </a>
                </div>
            </div>
            <div id="sidebar-content">
                <div id="message"></div>
                <div style="height: 100%; display: block;">
                    <div class="sidebar-node-info">
                        <!-- node info -->
                        <template v-if="node.id != -1">
                            <div :id="'accordion-'+node.id">
                                <div class="card">
                                    <div class="node-header" :id="'node-header-'+node.id" data-toggle="collapse"
                                         :data-target="'#node-info-'+node.id"
                                         aria-expanded="true" :aria-controls="'node-info-'+node.id">
                                        <i class="fa fa-angle-down"></i>
                                        <span>information</span>
                                    </div>

                                    <div :id="'node-info-'+node.id" class="collapse show"
                                         :aria-labelledby="'node-header-'+node.id" :data-parent="'accordion-'+node.id">
                                        <div style="position: relative; display: block;">
                                            <table class="node-info">
                                                <thead>
                                                <tr>
                                                    <td>name</td>
                                                    <td>value</td>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <template v-if="node.params.length != 0">
                                                    <template v-for="(model, index) in node.params">
                                                        <tr class="node-info-node-row">
                                                            <td>{{model.label[lang]}}</td>
                                                            <td>{{model.default}}</td>
                                                        </tr>
                                                    </template>
                                                </template>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- flow info -->
                        <template v-else>
                        </template>
                    </div>
                </div>
                <div style="height: 100%; display: none;">

                </div>
                <div style="height: 100%; display: none;">
                    <div class="sidebar-node-variable-space">
                        <template v-for="(flow, index) in variableSpace">
                            <div class="card">
                                <div class="node-header" :id="'node-header-'+flow.id" data-toggle="collapse"
                                     :data-target="'#variable-space-flow-'+flow.id"
                                     aria-expanded="true" :aria-controls="'variable-space-flow-'+flow.id">
                                    <i class="fa fa-angle-down"></i>
                                    <span :class="'flow-'+flow.id">{{flow.label}}</span>
                                </div>

                                <div :id="'variable-space-flow-'+flow.id" class="collapse show"
                                     :aria-labelledby="'node-header-'+flow.id" data-parent="#accordion">
                                    <div style="position: relative; display: block;">
                                        <table class="node-info">
                                            <thead>
                                            <tr>
                                                <td>id</td>
                                                <td>name</td>
                                                <td>size</td>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <template v-for="(node, index) in flow.nodes">
                                                <tr class="node-info-node-row">
                                                    <td>{{node.id}}</td>
                                                    <td>{{node.name}}</td>
                                                    <td>{{node.size}}</td>
                                                </tr>
                                            </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            <div id="sidebar-footer">
                <div style="display: none;">
                    <a class="sidebar-footer-button" id="workspace-config-node-collapse-all" href="#">
                        <i class="fa fa-angle-double-up"></i>
                    </a>
                    <a class="sidebar-footer-button" id="workspace-config-node-expand-all" href="#">
                        <i class="fa fa-angle-double-down"></i>
                    </a>
                </div>
                <div style="display: block;"></div>
                <div style="display: none;">
                    <span class="button-group">
                        <a id="debug-tab-open" class="sidebar-footer-button" href="#"
                           data-i18n="[title]node-red:debug.sidebar.openWindow" title="open in new window">
                            <i class="fa fa-desktop"></i>
                        </a>
                    </span>
                </div>
            </div>
            <div id="sidebar-shade" class="hide"></div>
        </div>
        <div id="sidebar-separator" class="ui-draggable"></div>
    </div>
    <div class="modal fade" id="nodeParamsModal" tabindex="-1" role="dialog" aria-labelledby="nodeParamsModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nodeParamsModalLabel">{{node.name}}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form method="post" id="main-form">
                        <template v-if="node.params.length != 0">
                            <template v-for="(model, index) in node.params">
                                <div class="form-group">
                                    <label :for="model.name" class="col-sm-3">{{model.label[lang]}}</label>
                                    <template v-if="model.type == 'list'">
                                        <select :name="model.name" class="col-sm-8">
                                            <option value="">全部</option>
                                            <template v-for="(option, id) in model.list">
                                                <option :value="option"
                                                        :selected="model.default == id || model.default == option">
                                                    {{option}}
                                                </option>
                                            </template>
                                        </select>
                                    </template>
                                    <template v-else-if="model.type == 'richtext'">
                                        <textarea :type="model.type" class="col-sm-8" :name="model.name"
                                                  :placeholder="model.default">{{model.default}}</textarea>
                                    </template>
                                    <template v-else-if="model.type == 'file'">
                                        <a href="javascript:;" class="file-upload">
                                            <span v-if="model.default==''">选择文件</span>
                                            <span v-else>更改文件</span>
                                            <input :id="'file_'+node.id" :type="model.type" class="col-sm-8"
                                                   :name="model.name"
                                                   :placeholder="model.default" accept="text/csv">
                                        </a>
                                        <span class="file-upload-path">{{model.default}}</span>
                                    </template>
                                    <template v-else>
                                        <input :type="model.type" class="col-sm-8" :name="model.name"
                                               :placeholder="model.default" :value="model.default">
                                    </template>
                                </div>
                            </template>

                        </template>
                        <template v-else>
                            <div class="form-group">
                                抱歉，暂时不可配置～
                            </div>
                        </template>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" @click="deleteNode()">删除</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveNodeConfig()">确定</button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>

<!--<script src="../config/config.min.js"></script>-->
<script src="../config/config.js"></script>
<script src="../public/custom/node/node.js"></script>
<script src="../public/js/cookie.js"></script>
<script src="../public/js/Echarts/echarts.js"></script>
<script src="../public/custom/index/index.js"></script>
<script src="../public/custom/charts/charts.js"></script>
<script src="../public/custom/websocket/websocket.js"></script>
<script src="../public/custom/charts/cluster.js"></script>
<script>
    // 说明：获取鼠标位置
    // 整理：http://www.codebit.cn
    // 来源：http://www.webreference.com
    function mousePosition(ev) {
        if (ev.pageX || ev.pageY) {
            return {x: ev.pageX, y: ev.pageY};
        }
        return {
            x: ev.clientX + document.body.scrollLeft - document.body.clientLeft,
            y: ev.clientY + document.body.scrollTop - document.body.clientTop
        };
    }
    document.onmousemove = mouseMove;

    function mouseMove(ev) {
        ev = ev || window.event;
        var mousePos = mousePosition(ev);
        //console.log("x: "+mousePos.x+"   y: " + mousePos.y);
    }
    //vue 绑定
    var vm = new Vue({
        el: '#vm',
        data: {
            init_finish: false,
            nodes: {},
            variableSpace: {},
            node: {
                id: "-1",
                name: "",
                type: "",
                params: []
            },
            flow:{
                "id": "-1",
                "type": "tab",
                "label": "Flow 1",
                "disabled": false,
                "info": "这是一个flow"
            },
            path: {
                id: "-1",
                from: "-1",
                to: "-1"
            },
            selected: "aa",
            lang: getCookieValue("lang"),
            routers: {},
            uploadFile: false,
        },
        mounted: function () {
            // 工作流初始化
            $(function () {
                // 默认有一个tabs
                workflow.tab.push({
                    id: currentTab,
                    type: "tab",
                    label: "Flow " + currentTab,
                    disabled: false,
                    info: ""
                });
                // 初始化左侧组件栏
                vm.nodes = nodes_category;
                if (vm.lang == "") {
                    vm.lang = 'zh';
                }
            });
            //工作流里的按钮
            $(function () {
                button_op();
            });
            // 键盘事件
            $(function () {
                $(document).ready(
                        function () {
                            document.onkeydown = function () {
                                var oEvent = window.event;
                                if (oEvent.keyCode === 46) {
                                    console.log(vm.path);
                                    //逻辑处理
                                    if (vm.node.id != "-1") {
                                        onNodeDelete(vm.node.id);
                                    }
                                    if (vm.path.id != "-1") {
                                        onPathDelete(vm.path.id);
                                    }

                                    // 重置
                                    reset();
                                }
                            }
                        });
            });
            // svg事件
            $(function () {
                separator();
            });

            // 配置事件
            $(function () {
                var collapse = $("#node-header-fd9028d1-470fa8");
                collapse.on('show.bs.collapse', function () {
                    // do something…
                    $('#sidebar-content .node-header > i').addClass("expanded");
                });
                collapse.on('hide.bs.collapse', function () {
                    // do something…
                    $('#sidebar-content .node-header > i').removeClass("expanded");
                });
            });

            // 文件更改事件
            $(function(){

            });

            // 加载工作流
            $(function () {
                //vm.init();
                vm.debug();
            })
        },
        updated: function () {
            // 初始化node拖拽
            if (!vm.init_finish) {  // 确保只初始化一次
                init();
                vm.init_finish = true;
            }
        },
        methods: {
            init: function () {
                // 加载工作流
                let verCode = "admin";
                $.ajax({
                    url: api_map.workflow_init + "?verCode=" + verCode,
                    type: 'POST',
                    contentType: 'application/json',
                    success: function (res) {
                        if (res.code == 0) {
                            vm.loadWorkflow(res.data.workflow);
                            vm.variableSpace = res.data.variableSpace;
                        } else {
                            console.log("用户不存在，请注册！");
                        }
                    }
                });
            },
            deploy: function () {
                // 生成节点路由表
                var routers = {};
                for (let tabIndex in workflow.nodes) {
                    routers[tabIndex] = {};
                    for (let nodeId in workflow.nodes[tabIndex]) {
                        var node_origin = workflow.nodes[tabIndex][nodeId];
                        var node_type = node_origin['type'];
                        var node_id = node_origin['id'];
                        if (!routers[tabIndex][node_id]) {
                            routers[tabIndex][node_id] = {
                                id: node_id,
                                last: [],
                                next: [],
                                algorithm: node_type,
                                paramsList: []
                            }
                        }
                        if (workflow.links[node_id] && workflow.links[node_id].length != 0) {
                            routers[tabIndex][node_id].next = workflow.links[node_id];
                            for (let i = 0; i < workflow.links[node_id].length; i++) {
                                let nId = workflow.links[node_id][i];
                                if (!routers[tabIndex][nId]) {
                                    routers[tabIndex][nId] = {
                                        id: nId,
                                        last: [],
                                        next: [],
                                        algorithm: workflow.nodes[tabIndex][nId]['type'],
                                        paramsList: []
                                    };
                                }
                                if (routers[tabIndex][nId].last.indexOf(node_id) < 0) {
                                    routers[tabIndex][nId].last.push(node_id);
                                }
                            }
                        }
                        var algoParamsList = node_params[node_type];
                        routers[tabIndex][node_id].paramsList = [];
                        for (var i = 0, len = algoParamsList.length; i < len; i++) {
                            var param_name = algoParamsList[i];
                            routers[tabIndex][node_id].paramsList.push(node_origin[param_name]);
                        }
                    }
                }
                // 检查路由正确性
                if (!this.checkRouters(routers[currentTab])) {
                    alert('error');
                    return false;
                }
                // 模型建立请求
                var request = {};
                request.verCode = workflow.verCode;
                request.routers = routers[currentTab];
                this.routers = routers[currentTab];  // 保存路由信息
                var data = JSON.stringify(request);
                console.log(request);
                // 发送工作流
                $.ajax({
                    url: api_map.workflow_deploy,
                    type: 'POST',
                    data: data,
                    contentType: 'application/json',
                    success: function (res) {
                        if (res.code == 0) {
                            workflow.verCode = res.data.verCode;
                            updateNodeStatus(res.data.initResult);
                        } else {
                            alert(res.msg);
                        }
                    },
                    error: function (res) {
                        alert('用户信息已失效，请重新登录！');
                    }
                });
            },
            runNode: function (nodeId) {
                var router = {};
                router[nodeId] = this.routers[nodeId];
                if (!this.checkRouters(router) || !this.checkNodeStatus(router)) {
                    alert('error');
                    return false;
                }

                this.onNodeRun(nodeId);

                var nodeRequest = {};
                nodeRequest.verCode = workflow.verCode;
                nodeRequest.routers = {};
                nodeRequest.routers[nodeId] = this.routers[nodeId];
                var data = JSON.stringify(nodeRequest);
                $.ajax({
                    url: api_map.node_run,
                    type: 'POST',
                    data: data,
                    contentType: 'application/json',
                    success: function (res) {
                        if (res.code == 0) {

                        } else {
                            alert(res.msg);
                            let nodeStatus = {};
                            nodeStatus[nodeId] = res.code;
                            updateNodeStatus(nodeStatus);
                            vm.onNodeReRun(nodeId);
                        }
                    }
                });
            },
            stopNode: function (nodeId) {
                this.onNodeStop(nodeId);
            },
            runWorkflow: function () {
                if (!this.checkRouters(this.routers) || !this.checkNodeStatus(this.routers)) {
                    alert('error');
                    return false;
                }
                var nodeRequest = {};
                nodeRequest.verCode = workflow.verCode;
                nodeRequest.routers = this.routers;
                var data = JSON.stringify(nodeRequest);
                $.ajax({
                    url: api_map.workflow_run,
                    type: 'POST',
                    data: data,
                    contentType: 'application/json',
                    success: function (res) {
                        if (res.code == 0) {
                            return true;
                        } else {
                            alert(res.msg);
                            return false;
                        }
                    }
                });
            },
            checkRouters: function (routers) {
                console.log(JSON.stringify(routers));
                // Check 1: 检测当前节点路由表是否为空
                var routersIsEmpty = (JSON.stringify(routers) == "{}" || JSON.stringify(routers) == undefined);
                if (routersIsEmpty) {
                    console.log("无节点");
                    return false;
                }

                // Check 2: 检测节点参数是否有误

                // Check 3: 检测链表中是否存在异常

                return true;
            },
            checkNodeStatus: function (routers) {
                // Check 4: 检测节点状态是否满足要求
                for (let nodeId in routers) {
                    var node = $('#' + nodeId);
                    var status = node.attr('status');
                    if (status == 3 || status == 5 || status == 7) {
                        alert('状态不正确');
                        return false;
                    }
                    if (status == 4) {
                        console.log('run again');
                    }
                }
                return true;
            },
            saveNodeConfig: function () {
                $('#nodeParamsModal').modal('hide');
                var data = $('#main-form').serializeArray();
                $.each(data, function () {
                    workflow.nodes[currentTab][vm.node.id][this.name] = this.value;
                });
                if (this.uploadFile) {
                    var nodeId = this.node.id;
                    var uploadFile = $('#file_' + nodeId)[0].files[0];
                    if (uploadFile == undefined) {
                        console.log("error");
                        return;
                    }

                    console.log(uploadFile);
                    workflow.nodes[currentTab][vm.node.id].path = uploadFile.name;

                    vm.onNodeRun(nodeId);

                    var flow = {};
                    flow.verCode = workflow.verCode;
                    flow.routers = {};
                    flow.routers[nodeId] = this.routers[nodeId];

                    var formData = new FormData();
                    formData.append('file', uploadFile);
                    formData.append('verCode', workflow.verCode);
                    formData.append('nodeId', vm.node.id);
                    formData.append('nodeType', vm.node.type);
                    formData.append('dataSetName', 'test');
                    $.ajax({
                        url: api_map.upload,
                        type: 'POST',
                        data: formData,
                        cache: false,    //上传文件不需缓存
                        processData: false, //需设置为false。因为data值是FormData对象，不需要对数据做处理
                        contentType: false, //需设置为false。因为是FormData对象，且已经声明了属性enctype="multipart/form-data"
                        success: function (res) {
                            if (res.code == 0) {
                                workflow.verCode = res.data.verCode;
                                updateNodeStatus(res.data.initResult);
                            } else {
                                vm.onNodeStop(nodeId);
                                alert(res.msg);
                            }
                        }
                    });
                }
                onNodeDetail(vm.node.id);
            },
            deleteNode: function () {
                onNodeDelete(vm.node.id);
                $('#nodeParamsModal').modal('hide');
            },
            onNodeRun: function (id) {
                $('#' + id + ' .run')
                        .attr('onclick', 'stopNode(' + id + ')')
                        .attr('fill', '#1aad19 !important')
                        .text('\uf04d');
            },
            onNodeStop: function (id) {
                $('#' + id + ' .run')
                        .attr('onclick', 'runNode(' + id + ')')
                        .attr('fill', '#1aad19 !important')
                        .text('\uf04b');
            },
            onNodeReRun: function (id) {
                $('#' + id + ' .run')
                        .attr('onclick', 'runNode(' + id + ')')
                        .attr('fill', '#1aad19 !important')
                        .text('\uf021');
            },
            changeTab: function (tab) {
                console.log(tab);

                $('.red-ui-tab-link-buttons a').removeClass('active selected');
                $('#sidebar-content > div').css({display: 'none'});
                $('#sidebar-tabs li').removeClass('active');
                var div = $('.sidebar-node-' + tab);
                var divs = $('')
                div.parent().css({display: 'block'});

                $('#red-ui-tab-' + tab + '-link-button').addClass('active selected');
                $('#sidebar-tabs #red-ui-tab-' + tab).addClass('active');
            },
            loadWorkflow: function (data) {
                if (data == "" || data == null || JSON.stringify(data) == "{}") {
                    return;
                }
                // 更新workflow
                workflow = data;

                // 渲染视图
                let svg = d3.select('#workflow svg');

                // 读取tab信息
                let tabs = data.tab;

                // to do
                // ...
                // 前端添加tab
                // 读取各节点的状态信息
                let status = {};
                for (let i = 0; i < tabs.length; i++) {
                    // 读取node信息
                    let tabId = tabs[i].id;
                    let nodes = data.nodes[tabId];
                    for (let nodeId in nodes) {
                        addNode(svg, nodes[nodeId]);
                        status[nodeId] = nodes[nodeId].status;
                    }
                }
                // 更新节点状态
                updateNodeStatus(status);

                // 读取link信息
                let links = data.links;
                for (let nodeId in links) {
                    let sNode = d3.select('g[id="' + nodeId + '"]');
                    for (let i = 0; i < links[nodeId].length; i++) {
                        let delta = getPathOffset(sNode);
                        let sdx = delta[0];
                        let sdy = delta[1];
                        translate = getTranslate(sNode);
                        points.push([sdx + translate[0], sdy + translate[1]]);

                        let eNode = d3.select('g[id="' + links[nodeId][i] + '"]');
                        let pathId = sNode.attr('id') + "_" + eNode.attr('id');

                        let eRect = eNode.node().getBoundingClientRect();
                        let edy = eRect.height / (+eNode.attr('inputs') + 1);
                        translate = getTranslate(eNode);

                        points[1] = [translate[0] - cableR, translate[1] + edy];

                        let input = eRect.height / (+eNode.attr('inputs') + 1);
                        activeLine = d3.select('#workflow svg')
                                .append('path')
                                .attr('class', 'cable')
                                .attr('from', sNode.attr('id'))
                                .attr('start', sdx + ', ' + sdy)
                                .attr('output', sNode.attr('output'))
                                .attr('d', getBezier(points))
                                .attr('to', eNode.attr('id'))
                                .attr('input', eNode.attr('input'))
                                .attr('end', '0, ' + input)
                                .attr('id', pathId)
                                .attr('onclick', 'onPathClick("' + pathId + '")');
                        activeLine = null;
                        points.length = 0;
                        translate = null;
                    }
                }

            },
            debug: function () {
                $.ajaxSettings.async = false;  // 同步执行
                var vs = {};
                $.getJSON("../config/variableSpace.json", function (data) {
                    $.each(data, function (flow, variable) {
                        vs[flow] = variable;
                    });
                });
                vm.variableSpace = vs;
                console.log(JSON.stringify(vm.variableSpace));
                $.ajaxSettings.async = true;  // 异步执行
            }
        }
    });

    function debug() {
        // 修改语言
        //changLang();

        // 加载默认工作流
        loadWorkflow();

        visualize({'op': 'motif'});
    }

    // 显示节点细节
    function onNodeDetail(id) {
        // 重制
        reset();
        var node = $('#' + id);
        node.addClass('active');
        var nodeType = node.attr("data-template-name");
        vm.node.id = id;
        vm.node.name = node_config[nodeType]['display'][vm.lang];
        vm.node.type = nodeType;
        vm.node.params = getNodeParams(id, nodeType);
        console.log('显示节点细节&显示节点可视化');
        // 如果该节点状态为已运行
        var status = node.attr('status');

        if (status == 4) {
            var flow = {};
            flow.verCode = workflow.verCode;
            flow.routers = {};
            flow.routers[id] = vm.routers[id];
            var nodeRequest = {};
            nodeRequest.workflow = flow;
            var data = JSON.stringify(flow);
            console.log("可视化");
            $.ajax({
                url: api_map.get_data + "?limit=0",
                type: 'POST',
                data: data,
                contentType: 'application/json',
                success: function (res) {
                    if (res.code == 0) {
                        console.log(res);
                        visualize(res.data);
                    } else {
                        alert(res.msg);
                    }
                }
            });
        }
    }

    // 配置节点
    function onNodeConfig(id) {
        // 显示配置窗口
        reset();
        $('#nodeParamsModal').modal('show');
        var node = $('#' + id);
        var nodeType = node.attr("data-template-name");

        vm.node.id = id;
        vm.node.name = node_config[nodeType]['display'][vm.lang];
        vm.node.type = nodeType;
        vm.node.params = getNodeParams(id, nodeType);
    }

    // 获取节点配置
    function getNodeParams(id, nodeType) {
        var currentParams = workflow.nodes[currentTab][id];

        var keyList = {};
        for (var key in currentParams) {
            keyList[key] = 1;
        }
        var params = [];
        var attrInfo = node_config[nodeType]['params'];

        for (var i = 0, len = attrInfo.length; i < len; i++) {
            if (attrInfo[i]['enable'] && attrInfo[i]['configurable']) {
                for (var key in keyList) {
                    if (attrInfo[i]['name'] == key) {
                        attrInfo[i]['default'] = currentParams[key];
                    }
                    if (attrInfo[i]['type'] == 'file') {
                        vm.uploadFile = true;
                        onUploadFileChange();
                    }
                }
                params.push(attrInfo[i]);
            }
        }
        return params;
    }

    // 运行节点
    function runNode(id) {
        vm.runNode(id);
    }

    // 暂停节点
    function stopNode(id) {
        vm.stopNode(id);
    }

    // 删除节点
    function onNodeDelete(id) {
        console.log("删除节点#" + id);
        // 删除与之相连的路径
        d3.selectAll('path[from="' + id + '"]').remove();
        d3.selectAll('g[id="' + id + '"]').remove();
        d3.selectAll('path[to="' + id + '"]').remove();

        // 删除workflow中的记录
        var node = workflow.nodes[currentTab][id];
        workflow.used[node.type] -= 1;
        delete workflow.nodes[currentTab][id];
        delete workflow.links[node.id];

        for (var nodeId in workflow.nodes[currentTab]) {
            if (workflow.links[nodeId]) {
                console.log(nodeId, workflow.links[nodeId]);
                var index = workflow.links[nodeId].indexOf(id.toString());
                if (index > -1) {
                    workflow.links[nodeId].splice(index, 1);
                }
            }
        }
        console.log(workflow);

        // 重置
        reset();
    }

    // 点击连线
    function onPathClick(id) {
        // 重置
        reset();
        d3.select('path[id="' + id + '"]').attr('class', 'cable active');
        vm.path.from = d3.select('path[id="' + id + '"]').attr('from');
        vm.path.to = d3.select('path[id="' + id + '"]').attr('to');
        vm.path.id = id;
        console.log(vm.path);
    }

    // 删除连线
    function onPathDelete(id) {
        d3.select('path[id="' + id + '"]').remove();
        var nodeIds = id.split("_");
        var sId = nodeIds[0];
        var eId = nodeIds[1];
        console.log(sId, eId);
        var index = workflow.links[sId].indexOf(eId.toString());
        if (index > -1) {
            workflow.links[sId].splice(index, 1);
        }
        console.log(workflow);

        // 重置
        reset();
    }

    // 更改语言
    function changLang() {
        if (vm.lang == 'en') {
            vm.lang = 'zh';
        } else {
            vm.lang = 'en';
        }
        setCookie('lang', vm.lang, 24, "/");
    }

    // 重置参数
    function reset() {
        d3.selectAll('svg .node').attr('class', 'node');
        d3.selectAll('svg .cable').attr('class', 'cable');
        vm.node = {
            id: "-1",
            name: "",
            type: "",
            params: []
        };
        vm.path = {
            id: "-1",
            from: "-1",
            to: "-1"
        };
        vm.uploadFile = false;

        // 重设各节点状态
        for (let nodeId in workflow.nodes[currentTab]) {
            d3.selectAll('g[id="' + nodeId + '"]')
                    .attr('class', 'node ' + nodeStatusMap[workflow.nodes[currentTab][nodeId].status]);
        }
    }

    // 可视化
    function visualize(data) {
        $('.visual-chart').attr('style', 'display:none');
        var op = data.op;
        switch (op) {
            case "data-upload":
            case "data-load":
            case "prehandle":
                console.log("data-load");
                $('#data-load').attr('style', 'display:block');
                showGraph(data.result);
                break;
            case "stl":
                console.log("stl");
                $('#abnormalChart').attr('style', 'display:block');
                abnormalVisual(data.result);
                break;
            case "motif":
                console.log("motif");
                $('#motifChart').attr('style', 'display:block');
                motifVisual(data.result);
                break;
            case "cluster":
                console.log("cluster");
                $('#cluster').attr('style', 'display:block');
                showCluster();
                break;
            default:
                console.log('default');
                break;
        }
    }

    // 上传文件
    function onUploadFileChange() {
        $(".file-upload").on("change","input[type='file']",function(){
            var filePath = $(this).val();
            var arr=filePath.split('\\');
            var fileName=arr[arr.length-1];
            $(".file-upload-path").html(fileName);
        })
    }
    function uiTab(l) {
        var E = "fa fa-lemon-o";
        var s, c, o, i, p = {}, u = 0, r = 0, f = l.element || $("#" + l.id), d = f.wrap("<div>").parent(), h = f.wrap("<div>").parent();
        if (d.addClass("red-ui-tabs"), l.vertical && d.addClass("red-ui-tabs-vertical"), l.addButton && "function" == typeof l.addButton && (d.addClass("red-ui-tabs-add"), $('<div class="red-ui-tab-button"><a href="#"><i class="fa fa-plus"></i></a></div>').appendTo(d).find("a").click(function (e) {
                    e.preventDefault(), l.addButton()
                })), l.scrollable && (d.addClass("red-ui-tabs-scrollable"), h.addClass("red-ui-tabs-scroll-container"), h.scroll(b), (o = $('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left"><a href="#" style="display:none;"><i class="fa fa-caret-left"></i></a></div>').appendTo(d).find("a")).on("mousedown", function (e) {
                    t(e, "-=150")
                }).on("click", function (e) {
                    e.preventDefault()
                }), (i = $('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right"><a href="#" style="display:none;"><i class="fa fa-caret-right"></i></a></div>').appendTo(d).find("a")).on("mousedown", function (e) {
                    t(e, "+=150")
                }).on("click", function (e) {
                    e.preventDefault()
                })), l.collapsible) {
            d.addClass("red-ui-tabs-collapsible");
            var g = $('<div class="red-ui-tab-link-buttons"></div>').appendTo(d), n = $('<a href="#"><i class="fa fa-caret-down"></i></a>').appendTo(g);
            n.addClass("red-ui-tab-link-button-menu"), n.click(function (e) {
                if (e.preventDefault(), !c) {
                    var i = [], a = [];
                    f.children().each(function (e, t) {
                        var n = $(t).data("tabId"), o = {
                            id: "red-ui-tabs-menu-option-" + n,
                            icon: p[n].iconClass || E,
                            label: p[n].name,
                            onselect: function () {
                                y(n)
                            }
                        };
                        p[n].pinned ? i.push(o) : a.push(o)
                    }), a = i.concat(a), (c = RED.menu.init({
                        id: "debug-message-option-menu",
                        options: a
                    })).css({position: "absolute"}), c.on("mouseleave", function () {
                        $(this).hide()
                    }), c.on("mouseup", function () {
                        $(this).hide()
                    }), c.appendTo("body")
                }
                var t = n.offset();
                c.css({
                    top: t.top + n.height() - 20 + "px",
                    left: t.left - c.width() + n.width() + "px"
                }), c.toggle()
            })
        }
        function t(e, t) {
            if (e.preventDefault(), !$(this).hasClass("disabled")) {
                var n = h.scrollLeft();
                h.animate({scrollLeft: t}, 100);
                var o = setInterval(function () {
                    var e = h.scrollLeft();
                    e !== n ? (n = e, h.animate({scrollLeft: t}, 100)) : clearInterval(o)
                }, 100);
                $(this).one("mouseup", function () {
                    clearInterval(o)
                })
            }
        }

        function v() {
            return l.onclick && l.onclick(p[$(this).attr("href").slice(1)]), y($(this)), !1
        }

        function b() {
            if (0 !== f.children().length) {
                var e = h.scrollLeft(), t = h.width(), n = f.width();
                0 === e ? o.hide() : o.show(), e === n - t ? i.hide() : i.show()
            }
        }

        function m() {
            return l.ondblclick && l.ondblclick(p[$(this).attr("href").slice(1)]), !1
        }

        function y(e) {
            if ("string" == typeof e && (e = f.find("a[href='#" + e + "']")), 0 !== e.length && !e.parent().hasClass("active")) {
                f.children().removeClass("active"), f.children().css({transition: "width 100ms"}), e.parent().addClass("active");
                var t = e.parent().attr("id");
                if (d.find(".red-ui-tab-link-button").removeClass("active selected"), $("#" + t + "-link-button").addClass("active selected"), l.scrollable) {
                    var n = e.parent().position().left;
                    n - 21 < 0 ? h.animate({scrollLeft: "+=" + (n - 50)}, 300) : n + 120 > h.width() && h.animate({scrollLeft: "+=" + (n + 140 - h.width())}, 300)
                }
                l.onchange && l.onchange(p[e.attr("href").slice(1)]), w(), setTimeout(function () {
                    f.children().css({transition: ""})
                }, 100)
            }
        }

        function w() {
            if (!l.vertical) {
                var e = f.find("li.red-ui-tab"), t = d.width(), n = e.length;
                if (l.collapsible) {
                    if ((i = t - g.width() - 10) < 198) {
                        for (var o = g.find("a:last").prev(); o.is(":not(:visible)");)o = o.prev();
                        o.hasClass("red-ui-tab-link-button-pinned") || o.hide(), i = t - g.width() - 10
                    } else 40 < t - 198 - g.width() && (g.find("a:not(:visible):first").show(), i = t - g.width() - 10);
                    e.css({width: i})
                } else {
                    var i;
                    if (r = (s = 100 * (i = (t - 12 - 6 * n) / n) / t + "%") + "%", l.scrollable) {
                        i = Math.max(i, 140), s = i + "px", r = 0;
                        var a = Math.max(d.width(), 12 + (i + 6) * n);
                        f.width(a), b()
                    } else l.hasOwnProperty("minimumActiveTabWidth") && (r = i < l.minimumActiveTabWidth ? (n -= 1, i = (t - 12 - l.minimumActiveTabWidth - 6 * n) / n, s = 100 * i / t + "%", l.minimumActiveTabWidth + "px") : 0);
                    l.collapsible && console.log(s), e.css({width: s}), i < 50 ? (f.find(".red-ui-tab-close").hide(), f.find(".red-ui-tab-icon").hide(), f.find(".red-ui-tab-label").css({paddingLeft: Math.min(12, Math.max(0, i - 38)) + "px"})) : (f.find(".red-ui-tab-close").show(), f.find(".red-ui-tab-icon").show(), f.find(".red-ui-tab-label").css({paddingLeft: ""})), 0 !== r && (f.find("li.red-ui-tab.active").css({width: l.minimumActiveTabWidth}), f.find("li.red-ui-tab.active .red-ui-tab-close").show(), f.find("li.red-ui-tab.active .red-ui-tab-icon").show(), f.find("li.red-ui-tab.active .red-ui-tab-label").css({paddingLeft: ""}))
                }
            }
        }

        function D(e) {
            var t = f.find("a[href='#" + e + "']").parent();
            if (t.hasClass("active")) {
                var n = t.prev();
                0 === n.size() && (n = t.next()), y(n.find("a"))
            }
            t.remove(), p[e].pinned && u--, l.onremove && l.onremove(p[e]), delete p[e], w(), c = null
        }

        return f.children().first().addClass("active"), f.children().addClass("red-ui-tab"), f.find("li.red-ui-tab a").on("click", v).on("dblclick", m), setTimeout(function () {
            w()
        }, 0), {
            addTab: function (t) {
                p[t.id] = t;
                var n = $("<li/>", {class: "red-ui-tab"}).appendTo(f);
                n.attr("id", "red-ui-tab-" + t.id.replace(".", "-")), n.data("tabId", t.id), l.maximumTabWidth && n.css("maxWidth", l.maximumTabWidth + "px");
                var e = $("<a/>", {href: "#" + t.id, class: "red-ui-tab-label"}).appendTo(n);
                if (t.icon ? $('<img src="' + t.icon + '" class="red-ui-tab-icon"/>').appendTo(e) : t.iconClass && $("<i>", {class: "red-ui-tab-icon " + t.iconClass}).appendTo(e), $("<span/>", {class: "bidiAware"}).text(t.label).appendTo(e).attr("dir", RED.text.bidi.resolveBaseTextDir(t.label)), l.collapsible) {
                    n.addClass("red-ui-tab-pinned");
                    var o = $('<a href="#' + t.id + '" class="red-ui-tab-link-button"></a>');
                    t.pinned ? 0 === u ? o.prependTo(g) : o.insertAfter(g.find("a.red-ui-tab-link-button-pinned:last")) : o.insertBefore(g.find("a:last")), o.attr("id", n.attr("id") + "-link-button"), t.iconClass ? $("<i>", {class: t.iconClass}).appendTo(o) : $("<i>", {class: E}).appendTo(o), o.click(function (e) {
                        e.preventDefault(), y(t.id)
                    }), t.pinned && (o.addClass("red-ui-tab-link-button-pinned"), u++), RED.popover.tooltip($(o), t.name)
                }
                if (e.on("click", v), e.on("dblclick", m), t.closeable) {
                    var i = $("<a/>", {href: "#", class: "red-ui-tab-close"}).appendTo(n);
                    i.append('<i class="fa fa-times" />'), i.on("click", function (e) {
                        e.preventDefault(), D(t.id)
                    })
                }
                if (l.onadd && l.onadd(t), e.attr("title", t.label), 1 == f.find("li.red-ui-tab").size() && y(e), l.onreorder) {
                    var a, s, r, d = [];
                    n.draggable({
                        axis: "x", distance: 20, start: function (e, t) {
                            a = [], d = [], f.children().each(function (e) {
                                d[e] = {
                                    el: $(this),
                                    text: $(this).text(),
                                    left: $(this).position().left,
                                    width: $(this).width()
                                }, $(this).is(n) && (r = s = e), a.push($(this).data("tabId"))
                            }), f.children().each(function (e) {
                                e !== s && $(this).css({
                                    position: "absolute",
                                    left: d[e].left + "px",
                                    width: d[e].width + 2,
                                    transition: "left 0.3s"
                                })
                            }), n.hasClass("active") || n.css({zIndex: 1})
                        }, drag: function (e, t) {
                            t.position.left += d[s].left + h.scrollLeft();
                            for (var n = t.position.left + d[s].width / 2 - h.scrollLeft(), o = 0; o < d.length; o++)if (o !== s && n > d[o].left && n < d[o].left + d[o].width) {
                                o < s ? (d[o].left += d[s].width + 8, d[s].el.detach().insertBefore(d[o].el)) : (d[o].left -= d[s].width + 8, d[s].el.detach().insertAfter(d[o].el)), d[o].el.css({left: d[o].left + "px"}), d.splice(o, 0, d.splice(s, 1)[0]), s = o;
                                break
                            }
                        }, stop: function (e, t) {
                            f.children().css({
                                position: "relative",
                                left: "",
                                transition: ""
                            }), n.hasClass("active") || n.css({zIndex: ""}), w(), r !== s && l.onreorder(a, $.makeArray(f.children().map(function () {
                                return $(this).data("tabId")
                            }))), y(d[s].el.data("tabId"))
                        }
                    })
                }
                setTimeout(function () {
                    w()
                }, 10), c = null
            }, removeTab: D, activateTab: y, nextTab: function () {
                var e = f.find("li.active").next();
                0 < e.length && y(e.find("a"))
            }, previousTab: function () {
                var e = f.find("li.active").prev();
                0 < e.length && y(e.find("a"))
            }, resize: w, count: function () {
                return f.find("li.red-ui-tab").size()
            }, contains: function (e) {
                return 0 < f.find("a[href='#" + e + "']").length
            }, renameTab: function (e, t) {
                p[e].label = t;
                var n = f.find("a[href='#" + e + "']");
                n.attr("title", t), n.find("span.bidiAware").text(t).attr("dir", RED.text.bidi.resolveBaseTextDir(t)), w()
            }, order: function (e) {
                var t = $.makeArray(f.children().map(function () {
                    return $(this).data("tabId")
                }));
                if (t.length === e.length) {
                    var n, o = !0;
                    for (n = 0; n < e.length; n++)if (e[n] !== t[n]) {
                        o = !1;
                        break
                    }
                    if (!o) {
                        var i = {};
                        for (f.children().detach().each(function () {
                            i[$(this).data("tabId")] = $(this)
                        }), n = 0; n < e.length; n++)i[e[n]].appendTo(f)
                    }
                }
            }
        }
    }
</script>