<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>时间序列聚类分类可视化分析平台</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="时间序列聚类分类可视化分析平台">
    <meta name="author" content="yzs">

    <link rel="stylesheet" type="text/css" href="../public/common/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../public/common/font-awesome/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../public/common/jquery-ui/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="../public/common/mutiple-select/multiple-select.css">
    <link rel="stylesheet" type="text/css" href="../public/common/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="../public/custom/index/index.css">
    <link rel="stylesheet" type="text/css" href="../public/custom/node/node.css">
    <link rel="stylesheet" type="text/css" href="../public/custom/charts/cluster.css">
    <link rel="stylesheet" type="text/css" href="../public/custom/cmd/cmd.css">

    <script src="../public/common/jquery/jquery.min.js"></script>
    <script src="../public/common/poper/popper.min.js"></script>
    <script src="../public/common/bootstrap/bootstrap.min.js"></script>
    <script src="../public/common/jquery-ui/jquery-ui.min.js"></script>
    <script src="../public/common/d3/d3.min.js"></script>
    <script src="../public/common/d3/d3-transform.min.js"></script>
    <script src="../public/common/vue/vue.min.js"></script>
</head>
<body>
<div id="vm">
    <div id="header">
        <span class="logo">
            <img src="../public/images/node-red.png" title="0.19.5">
            <span>时间序列聚类分类可视化分析平台</span>
        </span>
        <ul class="header-toolbar hide" style="display: block;">
            <li style="display: none;">
                <a id="btn-notifications" class="button" href="#">
                    <i class="fa fa-warning"></i>
                </a>
            </li>
            <li>
                <span class="opt-button-group button-group">
                    <a id="btn-deploy" class="opt-button" @click="deployWorkflow()">
                        <span class="opt-button-content" style="opacity: 1;">
                            <img id="btn-deploy-icon" src="../public/images/deploy-full-o.png">
                            <span>Deploy</span>
                        </span>
                        <span class="opt-button-spinner hide" style="display: none;">
                            <img src="../public/images/spin.svg">
                        </span>
                    </a>
                </span>
            </li>
            <li>
                <span class="opt-button-group button-group">
                    <a id="btn-run" class="opt-button" @click="runWorkflow">
                        <span class="opt-button-content" style="opacity: 1;">
                            <i class="fa fa-play-circle" aria-hidden="true"></i>
                            <span>Run</span>
                        </span>
                        <span class="opt-button-spinner hide" style="display: none;">
                            <img src="../public/images/spin.svg"></span>
                    </a>
                </span>
            </li>
            <!--<li>-->
                <!--<span class="opt-button-group button-group">-->
                    <!--<a id="btn-run2" class="opt-button" @click="runWorkflow2">-->
                        <!--<span class="opt-button-content" style="opacity: 1;">-->
                            <!--<i class="fa fa-play-circle" aria-hidden="true"></i>-->
                            <!--<span>Run on k8s</span>-->
                        <!--</span>-->
                        <!--<span class="opt-button-spinner hide" style="display: none;">-->
                            <!--<img src="../public/images/spin.svg"></span>-->
                    <!--</a>-->
                <!--</span>-->
            <!--</li>-->
            <li>
                <span class="opt-button-group button-group">
                    <a id="btn-logout" class="opt-button" @click="logout">
                        <span class="opt-button-content" style="opacity: 1;">
                            <i class="fa fa-play-circle" aria-hidden="true"></i>
                            <span>logout</span>
                        </span>
                        <span class="opt-button-spinner hide" style="display: none;">
                            <img src="../public/images/spin.svg"></span>
                    </a>
                </span>
            </li>

            <li>
                <span class="opt-button-group button-group">
                    <a id="btn-refresh" class="opt-button" @click="cleanCache">
                        <span class="opt-button-content" style="opacity: 1;">
                            <i class="fa fa-play-circle" aria-hidden="true"></i>
                            <span>clear</span>
                        </span>
                        <span class="opt-button-spinner hide" style="display: none;">
                            <img src="../public/images/spin.svg"></span>
                    </a>
                </span>
            </li>
            <!--<li>-->
            <!--<a class="btn btn-link" href="#"><i class="fa fa-play-circle-o" aria-hidden="true"></i>&nbsp;运行</a>-->
            <!--</li>-->
            <!--<a class="btn btn-link" href="#"><i class="fa fa-cloud-upload" aria-hidden="true"></i>&nbsp;部署</a>-->
            <!--<a class="btn btn-link" href="#"><i class="fa fa-share-alt" aria-hidden="true"></i>&nbsp;分享</a>-->
        </ul>
        <div id="header-shade" class="hide" style="display: none;"></div>
    </div>
    <div id="main-container">
        <!-- 动态加载工作流组件 -->
        <div class="left-wrapper" id="palette">
            <img src="../public/images/spin.svg" class="node-spinner hide" style="display: none;">
            <div id="node-search" class="node-search">
                <div class="searchBox-container">
                    <i class="fa fa-search"></i>
                    <input type="text" data-i18n="[placeholder]node.filter" placeholder="filter nodes"
                           v-model="nodeFilter">
                    <a href="#"><i class="fa fa-times"></i></a>
                    <span class="searchBox-resultCount hide"></span>
                </div>
            </div>
            <div id="node-container" class="node-scroll">
                <template v-for="(module, key) in nodeCategory">
                    <div :id="'node-container-' + key" class="node-category"
                         style="display: block;">
                        <div :id="'component-header-' + key" class="component-header">
                            <i class="expanded fa fa-angle-down"></i>
                            <span>{{module['display'][lang]}}</span>
                        </div>
                        <div class="component-content" :id="'node-base-category-'+key" style="">
                            <template v-for="(info, key) in module">
                                <template v-if="key=='nodes'">
                                    <template v-for="(node, key) in info">
                                        <div class="node" :data-template-name="key"
                                             style="background-color: #fff; height: 30px">
                                            <div class="node_label" dir="">{{node[lang]}}</div>
                                            <div class="node_icon_container">
                                                <div class="node_icon"
                                                     :style="'background-image: url(../public/images/'+node+'.png)'"></div>
                                            </div>

                                            <template v-if="node['out'] != 0">
                                                <div class="node_port node_port_output" style="top: -48px;"></div>
                                            </template>
                                            <template v-if="node['in'] != 0">
                                                <div class="node_port node_port_input"
                                                     :style="node['out'] != 0 ? 'top: -58px;' : 'top: -48px;'"></div>
                                            </template>
                                        </div>
                                    </template>
                                </template>
                                <template v-else-if="key=='sub_modules'">
                                    <template v-for="(subModule, subModuleName) in info">
                                        <div :id="'node-sub-header-' + subModuleName"
                                             class="component-header node-sub-header">
                                            <i class="fa fa-plus-circle" aria-hidden="true"></i>
                                            <span>{{subModule['display'][lang]}}</span>
                                        </div>
                                        <div class="component-content node-sub-content"
                                             :id="'node-sub-category-'+subModuleName" style="">
                                            <div v-for="(node, nodeName) in subModule['nodes']" class="node-sub-content"
                                                 :id="'node-sub-content-'+subModuleName"
                                                 :data-content-id="'node-sub-header-' + subModuleName">
                                                <div class="node" :data-template-name="nodeName"
                                                     style="background-color: #fff; height: 30px;">
                                                    <div class="node_label" dir="">{{node[lang]}}</div>
                                                    <div class="node_icon_container">
                                                        <div class="node_icon"
                                                             :style="'background-image: url(../public/images/'+node+'.png)'"></div>
                                                    </div>
                                                    <template v-if="node['out'] != 0">
                                                        <div class="node_port node_port_output"
                                                             style="top: -48px;"></div>
                                                    </template>
                                                    <template v-if="node['in'] != 0">
                                                        <div class="node_port node_port_input"
                                                             style="top: -58px;"></div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
            <div id="node-footer">
                <a class="node-button" id="node-collapse-all" href="#"><i
                        class="fa fa-angle-double-up"></i></a>
                <a class="node-button" id="node-expand-all" href="#"><i
                        class="fa fa-angle-double-down"></i></a>
            </div>
            <div id="node-shade" class="hide"></div>
        </div>
        <!-- 工作空间 -->
        <div class="middle-wrapper" id="workspace">
            <!-- 工作流 -->
            <div id="workflow" class="workflow" style="position: absolute; width: 100%; height: 45%; top:0;">
                <div class="red-ui-tabs red-ui-tabs-add red-ui-tabs-scrollable" style="display: block;z-index: 0;">
                    <div class="red-ui-tabs-scroll-container">
                        <ul id="workspace-tabs" style="width: 100%;" class="">
                            <template v-for="(flow, index) in flows">
                                <li :class="['red-ui-tab ui-draggable', flow.id==currentFlowId ? 'active' : '']"
                                    :id="'red-ui-tab-'+flow.id" style="width: 100%;">
                                    <a href="#" class="red-ui-tab-label" :title="flow.label"
                                       @click="changeWorkflow(flow.id)" @dblclick="configComponent(flow.id, flow.type)">
                                        <template v-if="flow.disabled">
                                            <span class="workspace-disabled-icon">
                                                <i class="fa fa-ban"></i>
                                            </span>
                                        </template>
                                        <span class="bidiAware" dir="#">{{flow.label}}</span>
                                    </a>
                                </li>
                            </template>
                        </ul>
                    </div>
                    <div class="red-ui-tab-button" id="workflow-add" @click="addWorkflow">
                        <a href="#"><i class="fa fa-plus"></i></a>
                    </div>
                    <div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left">
                        <a href="#" style="display: none;">
                            <i class="fa fa-caret-left"></i>
                        </a>
                    </div>
                    <div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right">
                        <a href="#" style="display: none;">
                            <i class="fa fa-caret-right"></i>
                        </a>
                    </div>
                </div>
                <div id="workflow-editor">
                    <!--<div class="btn-toolbar justify-content-between" role="toolbar" style="float: right; margin: 5px;">-->
                    <!--<div class="btn-group btn-group-sm" role="group" aria-label="First group">-->
                    <!--<button type="button" class="btn min" onclick="minScreen('workflow')" style="display: none;">-->
                    <!--<i class="fa fa-minus" aria-hidden="true"></i>-->
                    <!--</button>-->
                    <!--<button type="button" class="btn max" onclick="maxScreen('workflow')">-->
                    <!--<i class="fa fa-window-maximize" aria-hidden="true"></i>-->
                    <!--</button>-->
                    <!--</div>-->
                    <!--</div>-->
                    <svg width="5000" height="5000" pointer-events="all" style="position:relative;z-index: 0;"></svg>
                </div>
                <div id="workspace-footer">
                    <a class="workspace-footer-button" id="btn-zoom-out" href="#" style="display: inline-block;">
                        <i class="fa fa-minus"></i>
                    </a>
                    <a class="workspace-footer-button" id="btn-zoom-zero" href="#" style="display: inline-block;">
                        <i class="fa fa-circle-o"></i>
                    </a>
                    <a class="workspace-footer-button" id="btn-zoom-in" href="#" style="display: inline-block;">
                        <i class="fa fa-plus"></i></a>
                    <a class="workspace-footer-button-toggle single" id="btn-navigate" href="#"
                       style="display: inline-block;">
                        <i class="fa fa-map-o"></i>
                    </a>
                </div>
            </div>
            <!-- 可视化部分 -->
            <div id="visual" class="visual" style="position: absolute; width: 100%; height: 45%; top:45%;">
                <div class="btn-toolbar justify-content-between" role="toolbar" style="float: right;">
                    <div class="tab-title"><span>可视化</span></div>
                    <div class="btn-group btn-group-sm" role="group" aria-label="First group">
                        <button type="button" class="btn min" onclick="minScreen('visual')" style="display: none;">
                            <i class="fa fa-minus" aria-hidden="true"></i>
                        </button>
                        <button type="button" class="btn max" onclick="maxScreen('visual')">
                            <i class="fa fa-window-maximize" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                <div id="chart">
                    <div class="visual-chart" id="data-load"></div>
                    <div class="visual-chart" id="abnormalChart"></div>
                    <div class="visual-chart" id="cluster"></div>
                    <div class="visual-chart" id="matrixProfile">
                        <div id="matrixProfile1"></div>
                        <div id="matrixProfile2"></div>
                    </div>
                    <div class="visual-chart" id="hime">
                        <div id="himeChart" class="layui-col-md12"></div>
                        <div id="himeTableDiv" class="layui-col-md8">
                            <table id="himeTable" lay-filter="himeTable"></table>
                        </div>
                        <div id="subHimeChart" class="layui-col-md4"></div>
                    </div>
                    <div class="visual-chart" id="segment">
                        <div id="segmentTableDiv" class="layui-col-md2">
                            <table id="segmentTable" lay-filter="segmentTable"></table>
                        </div>
                        <div id="segmentChart" class="layui-col-md10"></div>
                    </div>
                </div>
            </div>

            <!-- 命令行部分 -->
            <!--<div id="command" class="command" style="position: absolute; width: 100%; height: 10%; top:90%;">-->
                <!--<div class="btn-toolbar justify-content-between" role="toolbar" style="float: right;">-->
                    <!--<div class="tab-title"><span>命令行</span></div>-->
                    <!--<div class="btn-group btn-group-sm" role="group" aria-label="First group">-->
                        <!--<button type="button" class="btn min" onclick="minScreen('command')" style="display: none;">-->
                            <!--<i class="fa fa-minus" aria-hidden="true"></i>-->
                        <!--</button>-->
                        <!--<button type="button" class="btn max" onclick="maxScreen('command')">-->
                            <!--<i class="fa fa-window-maximize" aria-hidden="true"></i>-->
                        <!--</button>-->
                    <!--</div>-->
                <!--</div>-->
                <!--<div id="cmd-shell" tabindex="-1">-->
                    <!--<div class="shell-view">-->
                        <!--<span class="prompt">$</span>-->
                        <!--<span class="input">-->
                            <!--<span class="left"></span>-->
                            <!--<span class="cursor"></span>-->
                            <!--<span class="right"></span>-->
                        <!--</span>-->
                    <!--</div>-->
                <!--</div>-->
            <!--</div>-->

            <!--<div id="workflow-separator" class="ui-draggable separator"></div>-->
            <!--<div id="visual-separator" class="ui-draggable separator"></div>-->
        </div>
        <!-- 信息栏 -->
        <div class="right-wrapper" id="sidebar">
            <div class="red-ui-tabs red-ui-tabs-collapsible">
                <div>
                    <ul id="sidebar-tabs">
                        <li class="red-ui-tab red-ui-tab-pinned active" id="red-ui-tab-info" style="width: 125px;">
                            <a href="#info" class="red-ui-tab-label" title="info">
                                <i class="red-ui-tab-icon fa fa-info"></i>
                                <span class="bidiAware" dir="">info</span>
                            </a>
                        </li>
                        <li class="red-ui-tab red-ui-tab-pinned" id="red-ui-tab-status" style="width: 125px;">
                            <a href="#status" class="red-ui-tab-label" title="status">
                                <i class="red-ui-tab-icon fa fa-cog"></i>
                                <span class="bidiAware" dir="">status</span>
                            </a>
                        </li>
                        <li class="red-ui-tab red-ui-tab-pinned" id="red-ui-tab-variable-space" style="width: 125px;">
                            <a href="#variable-space" class="red-ui-tab-label" title="variable-space">
                                <i class="red-ui-tab-icon fa fa-database"></i>
                                <span class="bidiAware" dir="">variable-space</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="red-ui-tab-link-buttons">
                    <a href="javascript:void(0);"
                       class="red-ui-tab-link-button red-ui-tab-link-button-pinned active selected"
                       id="red-ui-tab-info-link-button" @click="changeTab('info')">
                        <i class="fa fa-info"></i>
                    </a>
                    <a href="javascript:void(0);" class="red-ui-tab-link-button" id="red-ui-tab-status-link-button"
                       style="display: inline-block;" @click="changeTab('status')">
                        <i class="fa fa-cog"></i>
                    </a>
                    <a href="javascript:void(0);" class="red-ui-tab-link-button red-ui-tab-link-button-pinned"
                       id="red-ui-tab-variable-space-link-button" @click="changeTab('variable-space')">
                        <i class="fa fa-database"></i>
                    </a>
                </div>
            </div>
            <div id="sidebar-content">
                <div style="height: 100%; display: block;">
                    <div class="sidebar-info">
                        <!-- component info -->
                        <template v-if="component.id != ''">
                            <div :id="'sidebar-info-'+component.id">
                                <div class="component-header" :id="'component-header-params-'+component.id">
                                    <i class="fa fa-angle-down expanded"></i>
                                    <span>information</span>
                                </div>
                                <div :id="'node-params-'+component.id" class="component-content">
                                    <div style="position: relative; display: block;">
                                        <table class="node-info">
                                            <thead>
                                            <tr>
                                                <td>name</td>
                                                <td>value</td>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <template v-for="(model, index) in component.params">
                                                <tr class="node-info-node-row" v-if="!('dependsOn' in model) || ('dependsOn' in model && component.params[model.dependsOn].default)">
                                                    <td>{{model.label[lang]}}</td>
                                                    <td>{{cutString(model.default)}}</td>
                                                </tr>
                                            </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div :id="'sidebar-description-'+component.id">
                                <div class="component-header" :id="'component-header-description-'+component.id">
                                    <i class="fa fa-angle-down expanded"></i>
                                    <span>description</span>
                                </div>
                                <div :id="'node-description-'+component.id" class="component-content">
                                    <div style="position: relative; display: block;">
                                        {{component.description}}
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                <div style="height: 100%; display: none;">

                </div>
                <div style="height: 100%; display: none;">
                    <div class="sidebar-variable-space">
                        <template v-for="(flow, index) in variableSpace">
                            <div class="component-header" :id="'variable-header-'+index">
                                <i class="fa fa-angle-down expanded"></i>
                                <span :class="'flow-'+index">{{flows[index].label}}</span>
                            </div>

                            <div :id="'variable-space-flow-'+index" class="component-content">
                                <div style="position: relative; display: block;">
                                    <table class="node-info">
                                        <thead>
                                        <tr>
                                            <td>name</td>
                                            <td>size</td>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <template v-for="node in flow">
                                            <template v-if="node.name != ''">
                                                <tr :class="['node-info-node-row', component.id == node.id ? 'active' : '']"
                                                    @click="onRowSelected(node.id)">
                                                    <td>{{node.name}}</td>
                                                    <td>{{node.size}}</td>
                                                </tr>
                                            </template>
                                        </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            <div id="sidebar-footer">
                <div style="display: none;">
                    <a class="sidebar-footer-button" id="workspace-config-node-collapse-all" href="#">
                        <i class="fa fa-angle-double-up"></i>
                    </a>
                    <a class="sidebar-footer-button" id="workspace-config-node-expand-all" href="#">
                        <i class="fa fa-angle-double-down"></i>
                    </a>
                </div>
                <div style="display: block;"></div>
                <div style="display: none;">
                    <span class="button-group">
                        <a id="debug-tab-open" class="sidebar-footer-button" href="#"
                           data-i18n="[title]node-red:debug.sidebar.openWindow" title="open in new window">
                            <i class="fa fa-desktop"></i>
                        </a>
                    </span>
                </div>
            </div>
            <div id="sidebar-shade" class="hide"></div>
        </div>
        <div id="sidebar-separator" class="ui-draggable"></div>
    </div>
    <div class="modal fade" id="configModal" tabindex="-1" role="dialog" aria-labelledby="configModalHeader"
         aria-hidden="true" data-backdrop='static'>
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <template v-if="component.id != ''">
                    <div class="modal-header">
                        <h5 class="modal-title" id="configModalHeader">{{component.name}}</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form method="post" id="main-form">
                            <template v-if="component.params.length != 0">
                                <template v-if="component.type == 'data-load'">
                                    <template v-for="(model, index) in component.params">
                                        <div class="form-group row" v-if="!('dependsOn' in model) || ('dependsOn' in model && component.params[model.dependsOn].default)">
                                            <label :for="model.name" class="col-sm-3 col-form-label">{{model.label[lang]}}</label>
                                            <div class="col-sm-8">
                                                <template v-if="model.type == 'list'">
                                                    <template v-if="model.name == 'data_set'">
                                                        <select class="form-control" :name="model.name"
                                                                v-model="model.default" @change="onDataSetChanged">
                                                            <template v-for="(option, id) in dataSets">
                                                                <option :value="id"
                                                                        :selected="model.default == id || model.default == option.subDataSet">
                                                                    {{option.subDataSet}}
                                                                </option>
                                                            </template>
                                                        </select>
                                                    </template>
                                                    <template v-else>
                                                        <select class="form-control" :name="model.name"
                                                                v-model="model.default">
                                                            <template v-for="(option, id) in model.list">
                                                                <option :value="option"
                                                                        :selected="model.default == id || model.default == option">
                                                                    {{option}}
                                                                </option>
                                                            </template>
                                                        </select>
                                                    </template>
                                                </template>
                                                <template v-else-if="model.type == 'multi-list'">
                                                    <template v-if="model.name == 'field_info'">
                                                        <select class="multiple form-control" multiple="multiple"
                                                                :name="model.name" v-model="model.default">
                                                            <template v-for="(fieldName, id) in dataSet.fieldName">
                                                                <option :value="fieldName"
                                                                        :selected="model.default == id || model.default == fieldName">
                                                                    {{fieldName}}({{dataSet.fieldType[id]}})
                                                                </option>
                                                            </template>
                                                        </select>
                                                    </template>
                                                    <template v-else-if="model.name == 'tag'">
                                                        <template v-for="(tagMap, tagName) in dataSet.tag">
                                                            <label>{{tagName}}</label>
                                                            <select class="multiple form-control" multiple="multiple"
                                                                    :name="tagName" v-model="model.default[tagName]">
                                                                <template v-for="(value, key) in tagMap">
                                                                    <option :value="key"
                                                                            :selected="model.default[tagName]">
                                                                        {{key}}
                                                                    </option>
                                                                </template>
                                                            </select>
                                                        </template>
                                                    </template>
                                                </template>
                                                <template v-else-if="model.type == 'richtext'">
                                                    <textarea class="form-control" :type="model.type" :name="model.name"
                                                              :placeholder="dataSet.description"
                                                              :disabled="model.configurable ? '' : 'disabled'"
                                                              v-model="model.default">{{dataSet.description}}</textarea>
                                                </template>
                                                <template v-else-if="model.type == 'checkbox'">
                                                    <input class="form-control" :type="model.type" :name="model.name"
                                                           :checked="model.default ? 'checked' : ''"
                                                           v-model='model.default'>
                                                </template>
                                                <template v-else>
                                                    <template v-if="model.name == 'variable'">
                                                        <input :class="['form-control', repeatVariable ? 'has-error' : '']"
                                                               :type="model.type" :name="model.name"
                                                               :placeholder="model.default" :value="model.default"
                                                               v-model="model.default">
                                                        <template v-if="repeatVariable">
                                                            <div class="help-block">变量名重复</div>
                                                        </template>
                                                    </template>
                                                    <template v-else>
                                                        <input class="form-control" :type="model.type"
                                                               :name="model.name"
                                                               :placeholder="model.default" :value="model.default"
                                                               v-model="model.default">
                                                    </template>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                                <template v-else>
                                    <template v-for="(model, index) in component.params">
                                        <div class="form-group row" v-if="!('dependsOn' in model) || ('dependsOn' in model && component.params[model.dependsOn].default)">
                                            <label :for="model.name" class="col-sm-3 col-form-label">{{model.label[lang]}}</label>
                                            <div class="col-sm-8">
                                                <template v-if="model.type == 'list'">
                                                    <select class="form-control" :name="model.name"
                                                            v-model="model.default">
                                                        <template v-for="(option, id) in model.list">
                                                            <option :value="option"
                                                                    :selected="model.default == id || model.default == option">
                                                                {{option}}
                                                            </option>
                                                        </template>
                                                    </select>
                                                </template>
                                                <template v-else-if="model.type == 'richtext'">
                                                    <template v-if="model.dependsOn != undefined">
                                                        <textarea class="form-control" :type="model.type" :name="model.name"
                                                                  :placeholder="model.default"
                                                                  :disabled="model.configurable"
                                                                  v-model="model.default">{{model.default}}</textarea>
                                                    </template>
                                                </template>
                                                <template v-else-if="model.type == 'file'">
                                                    <a href="javascript:;" class="file-upload">
                                                        <span v-if="model.default==''">选择文件</span>
                                                        <span v-else>更改文件</span>
                                                        <input :id="'file_'+component.id" :type="model.type"
                                                               class="col-sm-8"
                                                               :name="model.name"
                                                               :placeholder="model.default"
                                                               accept="text/csv" @change="getFile($event)" multiple>
                                                    </a>
                                                    <span class="file-upload-path">{{cutString(model.default)}}</span>
                                                </template>
                                                <template v-else>
                                                    <template v-if="model.name == 'variable'">
                                                        <input :class="['form-control', repeatVariable ? 'has-error' : '']"
                                                               :type="model.type" :name="model.name"
                                                               :placeholder="model.default" :value="model.default"
                                                               v-model="model.default">
                                                        <template v-if="repeatVariable">
                                                            <div class="help-block">变量名重复</div>
                                                        </template>
                                                    </template>
                                                    <template v-else>
                                                        <input class="form-control" :type="model.type"
                                                               :name="model.name"
                                                               :placeholder="model.default" :value="model.default"
                                                               v-model="model.default">
                                                    </template>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                            </template>
                            <template v-else>
                                <div class="form-group">
                                    抱歉，暂时不可配置～
                                </div>
                            </template>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-warning" @click="deleteComponent()">删除</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" @click="saveComponentConfig()">确定</button>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>
</body>
</html>

<script src="../public/custom/debug/debug.js"></script>
<script src="../public/custom/config/config.min.js"></script>
<script src="../public/custom/node/node.js"></script>
<script src="../public/custom/index/index.js"></script>
<script src="../public/custom/charts/charts.js"></script>
<script src="../public/custom/charts/cluster.js"></script>
<script src="../public/custom/charts/motif.js"></script>
<script src="../public/custom/charts/matrixProfile.js"></script>
<script src="../public/custom/charts/hime.js"></script>
<script src="../public/custom/charts/segmentation.js"></script>
<script src="../public/custom/cmd/cmd.js"></script>
<script src="../public/custom/cookie/cookie.js"></script>
<script src="../public/custom/webSocket/webSocket.js"></script>
<script src="../public/common/mutiple-select/multiple-select.js"></script>
<script>
    //vue 绑定
    var vm = new Vue({
        el: '#vm',
        data: {
            initFinish: false,
            nodeFilter: "",
            nodeCategory: {},
            nodeCategoryCopy: {},
            dataSets: {},
            dataSet: {},
            workflowChanged: false,
            dataLoadConfigLock: false,
            dataLoadConfig: false,
            configFlag: false,
            currentFlowId: 0,
            flows: {},
            variableSpace: {},
            variableSpaceMap: {},
            repeatVariable: false,
            component: {
                id: "",
                name: "",
                type: "",
                params: [],
                description: "",
            },
            path: {
                id: "",
                from: "",
                to: ""
            },
            routers: {},
            uploadFile: false,
            uploadFilePaths: null,
            lang: getCookieValue("lang"),
        },
        mounted: function () {
            // 工作流初始化
            $(function () {
                // 获取token
                workflow.token = getCookieValue("token");
                console.log("token: ", workflow.token);
                if (workflow.token == "" || workflow.token == undefined || workflow.token == null) {
                    window.location.href = 'login.html';
                }

                // 初始化左侧组件栏
                vm.nodeCategory = node_category;
                vm.nodeCategoryCopy = node_category;

                // 初始化系统语言
                if (vm.lang == "") {
                    vm.lang = 'zh';
                }

                // 键盘事件
                document.onkeydown = function () {
                    var oEvent = window.event;
                    if (oEvent.keyCode === 46) {
                        //逻辑处理
                        if (vm.path.id != "") {
                            onPathDelete(vm.path.id);
                            return;
                        }
                        if (vm.component.id != "") {
                            onComponentDelete(vm.component.id, vm.component.type);
                        }
                    }
                };

                // separator事件
                separator();

                // 加载数据集列表
                vm.getDataSetList();

                // 默认有一个flow
                vm.loadWorkflow();
            });
        },
        updated: function () {
            // 初始化node拖拽
            if (!vm.initFinish) {  // 确保只初始化一次
                init();
                let modal = $('#configModal');
                modal.on('shown.bs.modal', function () {
                    console.log('shown');
                    vm.configFlag = true;
                    vm.dataLoadConfigLock = (vm.component.type == "data-load");
                });
                modal.on('hidden.bs.modal', function () {
                    console.log('hidden');
                    vm.configFlag = false;
                });
                vm.initFinish = true;
            }

            // 绑定节点列表事件
            $('.component-header').unbind().click(function () {
                var id = $(this).attr('id');
                var nextId = $(this).next().attr('id');
                var el_i = $('#' + id + ' >i');
                el_i.toggleClass('expanded');
                var nextEl = $('#' + nextId);
                nextEl.slideToggle(500);
            });
            $('#node-collapse-all').unbind().click(function (e) {
                var container = $('#node-container');
                container.find('.component-header > i').removeClass('expanded');
                container.find('.component-content').slideUp(500);
            });

            $('#node-expand-all').unbind().click(function (e) {
                var container = $('#node-container');
                container.find('.component-header > i').addClass('expanded');
                container.find('.component-content').slideDown(500);
            });

            // 如果配置
            if (!vm.dataLoadConfigLock && vm.configFlag) {
                $('.ms-parent').remove();
                let selector = $("select.multiple");
                selector.multipleSelect('destroy');
                selector.multipleSelect({
                    filter: true,
                    multiple: true,
                    selectAll: true,
                    width: "100%"
                });
                for (let t in vm.dataSet.tag) {
                    let selectedList = workflow.task[vm.component.id].tag[t];
                    $("select[name='" + t + "']").multipleSelect('setSelects', selectedList);
                }
                vm.dataLoadConfigLock = true;
            }
        },
        methods: {
            // 加载工作流
            loadWorkflow: function () {
                console.log('loading');
                $.ajax({
                    url: api_map.workflow_load,
                    type: 'POST',
                    data: {
                        token: workflow.token
                    },
                    dataType: 'json',
                    success: function (res) {
                        if (res.code == 0) {
                            // 更新工作流
                            console.log('存在工作流');
                            workflow = res.data.workflow;
                            vm.updateWorkflow(workflow);
                        } else {
                            // 新建默认工作流
                            console.log('新建默认工作流');
                            vm.addWorkflow();
                        }
                    }
                });
            },
            deployWorkflow: function (callback=null) {
                // 发送工作流
                // $.ajax({
                //     url: api_map.workflow_deploy + "?type=1",
                //     type: 'POST',
                //     data: JSON.stringify(workflow),
                //     contentType: 'application/json',
                //     beforeSend: function () {
                        console.log('before deploy');
                //         // 防止多次部署
                        vm.disabledA('#btn-deploy');
                //     },
                //     success: function (res) {
                //         if (res.code == 0) {
                            workflow.token = "admin";
                            console.log("deployWorkFlow");
                            let status = {};
              for (let taskKey in workflow.task) {
                status[taskKey] = 1;
              }
                            updateNodeStatus(status);
                //         } else {
                //             alert(res.msg);
                //             vm.enableA('#btn-deploy');
                //         }
                //     },
                //     complete: function () {
                //         console.log('deploy complete');
                //     },
                //     error: function (res) {
                //         alert('啊哦，服务器连接失败了～');
                //     }
                // });
                // if (callback != null) {
                //     callback();
                // }
            },
            saveWorkflow: function () {
                console.log('保存工作流');
                $.ajax({
                    url: api_map.workflow_save,
                    type: 'POST',
                    data: JSON.stringify(workflow),
                    contentType: 'application/json',
                    success: function (res) {
                        if (res.code == 0) {
                            console.log("工作流保存成功");
                        } else {
                            console.log("工作流保存失败");
                        }
                    }
                });
            },
            runWorkflow: function () {
              console.log("run workflow");
              setInterval(function(){
                let status = {};
                for (let taskKey in workflow.task) {
                  status[taskKey] = workflow.task[taskKey].status;
                }
                for (let taskKey in workflow.task) {
                  if (workflow.task[taskKey].status === 3) {
                    status[taskKey] = 4;
                  }
                }
                for (let taskKey in workflow.task) {
                  if (workflow.task[taskKey].status === 1) {
                    status[taskKey] = 3;
                    break;
                  }
                }
                updateNodeStatus(status);
              }, 1000);
                // 如果无节点，返回false
                // if (vm.flows[vm.currentFlowId].nodes.length == 0) {
                //     alert("工作流无节点！");
                //     return false;
                // }
                //
                // for (let index in vm.flows[vm.currentFlowId].nodes) {
                //     let nodeId = vm.flows[vm.currentFlowId].nodes[index];
                //     if (!vm.checkNodeStatus(nodeId)) {
                //         continue;
                //     }
                //     let nodeStatus = {};
                //     nodeStatus[nodeId] = status_map.RUNNING;
                //     updateNodeStatus(nodeStatus);
                // }
                //
                // console.log('run workflow on docker');
                //
                // // 运行节点
                // $.ajax({
                //     url: api_map.workflow_run,
                //     type: 'POST',
                //     data: {
                //         token: workflow.token,
                //         flowId: vm.currentFlowId
                //     },
                //     dataType: 'json',
                //     beforeSend: function () {
                //         vm.disabledA('#btn-run');
                //     },
                //     success: function (res) {
                //         if (res.code == 0) {
                //             console.log("节点们正在运行。。。");
                //         } else {
                //             alert(res.msg);
                //             let nodeStatus = {};
                //             for (let index in workflow.task[vm.currentFlowId].nodes) {
                //                 let nodeId = workflow.task[vm.currentFlowId].nodes[index];
                //                 nodeStatus[nodeId] = res.code;
                //             }
                //             updateNodeStatus(nodeStatus);
                //         }
                //     },
                //     complete: function () {
                //         vm.enableA('#btn-run');
                //     }
                // });

            },
            runWorkflow2: function () {
                // 如果无节点，返回false
                if (vm.flows[vm.currentFlowId].nodes.length == 0) {
                    alert("工作流无节点！");
                    return false;
                }

                for (let index in vm.flows[vm.currentFlowId].nodes) {
                    let nodeId = vm.flows[vm.currentFlowId].nodes[index];
                    if (!vm.checkNodeStatus(nodeId)) {
                        continue;
                    }
                    let nodeStatus = {};
                    nodeStatus[nodeId] = status_map.RUNNING;
                    updateNodeStatus(nodeStatus);
                }
                console.log('run workflow on k8s');
                // 运行节点
                $.ajax({
                    url: api_map.workflow_run2,
                    type: 'POST',
                    data: {
                        token: workflow.token,
                        flowId: vm.currentFlowId
                    },
                    dataType: 'json',
                    beforeSend: function () {
                        vm.disabledA('#btn-run');
                    },
                    success: function (res) {
                        if (res.code == 0) {
                            console.log("节点们正在运行。。。");
                        } else {
                            alert(res.msg);
                            let nodeStatus = {};
                            for (let index in workflow.task[vm.currentFlowId].nodes) {
                                let nodeId = workflow.task[vm.currentFlowId].nodes[index];
                                nodeStatus[nodeId] = res.code;
                            }
                            updateNodeStatus(nodeStatus);
                        }
                    },
                    complete: function () {
                        vm.enableA('#btn-run');
                    }
                });

            },
            addWorkflow: function () {
                if (!workflow.used.flow) {
                    workflow.used.flow = 0;
                }
                let flowId = parseInt(workflow.used.flow) + 1;  // 暂时使用自增
                workflow.used.flow += 1;
                while (workflow.task[flowId]) {
                    console.error("工作流id重复！");
                    flowId += 1;
                }
                workflow.task[flowId] = {
                    id: flowId,
                    type: "flow",
                    label: "Flow " + flowId,
                    disabled: false,
                    description: "这是一个新flow",
                    nodes: []
                };
                // 切换工作流
                workflow.currentFlowId = flowId;
                vm.updateWorkflow(workflow);
            },
            changeWorkflow: function (flowId, force = false) {
                // 记录上一flow
                let lastFlowId = vm.currentFlowId;
                // 如果点击同一个flow，忽略该事件
                if (lastFlowId == flowId && !force) {
                    console.log("重复点击，该操作无效");
                    return;
                }
                // 更新当前flow
                vm.currentFlowId = parseInt(flowId);
                workflow.currentFlowId = parseInt(flowId);
                // 清除上一flow的节点
                hideNodesByFlow(lastFlowId);
                // 添加当前flow的节点
                showNodesByFlow(flowId);
                // 更新vue值
                vm.update();
            },
            updateWorkflow: function (workflow, id = null) {
                // 如果工作流为空，则增加默认的工作流任务栏
                if (workflow == ''
                        || workflow == null
                        || JSON.stringify(workflow) == '{}'
                        || JSON.stringify(workflow.task) == undefined
                        || JSON.stringify(workflow.task) == '{}') {
                    vm.addWorkflow();
                    return;
                }

                // 更新对象
                let task = {};
                // ID不为空，代表修改的是某组件的属性，不需要全部刷新
                if (id != null) {
                    // 代表是该flow发生了变化
                    if (vm.flows[id]) {
                        vm.flows[id] = workflow.task[id];
                        task[id] = workflow.task[id];
                    }
                    // 代表是flow下的节点发生了变化
                    else if (workflow.task[id]) {
                        let flowId = workflow.task[id].z;
                        vm.variableSpace[flowId][id] = {
                            id: id,
                            name: workflow.task[id].variable,
                            size: workflow.task[id].size
                        };
                        console.log('更新完成');
                        return;
                    }
                } else {
                    // 更新工作流
                    task = workflow.task;
                    vm.flows = {};
                    vm.variableSpace = {};
                    vm.variableSpaceMap = {};
                }

                // 获取任务栏即变量空间
                for (let id in task) {
                    console.log(id);
                    if (!task[id]) {
                        continue;
                    }
                    if (task[id].type == "flow") {
                        vm.flows[id] = task[id];
                        vm.variableSpace[id] = {};
                        vm.variableSpaceMap[id] = {};
                    } else {
                        var flowId = task[id].z;
                        if (task[id].variable == "") {
                            continue;
                        }
                        vm.variableSpace[flowId][id] = {
                            id: id,
                            name: task[id].variable,
                            size: task[id].size
                        };
                        vm.variableSpaceMap[flowId][task[id].variable] = id;
                    }
                }
                console.log(workflow);
                // 切换当前工作流
                // if (workflow.currentFlowId == null) {
                //     console.log('默认工作流为空');
                //     // 显示第一个任务栏
                //     for (let flowId in vm.flows) {
                //         vm.changeWorkflow(flowId, true);
                //         break;
                //     }
                // } else {
                //     console.log('默认工作流为#flow:' + workflow.currentFlowId);
                //     vm.changeWorkflow(workflow.currentFlowId, true);
                // }
            },

            upload: function (nodeId) {
                //vm.deployWorkflow(function () {
                    console.log('上传文件', nodeId);
                    //vm.uploadFilePaths = vm.uploadFilePaths || getCookieValue(nodeId);
                    if (vm.uploadFilePaths == null) {
                        console.error('文件为空');
                        alert('错误：文件为空！请选择上传文件。');
                        return false;
                    }
                    JSON.stringify('文件', vm.uploadFilePaths.name);
                    var formData = new FormData();
                    formData.append('token', workflow.token);
                    formData.append('flowId', vm.currentFlowId);
                    formData.append('nodeId', nodeId);
                    formData.append('file', vm.uploadFilePaths);
                    JSON.stringify(formData);
                    $.ajax({
                        url: api_map.data_upload,
                        type: 'POST',
                        data: formData,
                        cache: false,       //上传文件不需缓存
                        processData: false, //需设置为false。因为data值是FormData对象，不需要对数据做处理
                        contentType: false, //需设置为false。因为是FormData对象，且已经声明了属性enctype="multipart/form-data"
                        beforeSend: function () {
                            vm.onNodeRun(nodeId);
                        },
                        success: function (res) {
                            if (res.code == 0) {
                                updateNodeStatus(res.data.status);
                                return true;
                            } else {
                                alert(res.msg);
                                vm.onNodeStop(nodeId);
                                return false;
                            }
                        },
                        error: function () {
                            vm.onNodeStop(nodeId);
                        },
                        complete: function () {
                            vm.uploadFilePaths = null;
                            vm.uploadFile = false;
                            vm.getDataSetList();
                        }
                    });
                    return true;
                // });
            },
            runNode: function (nodeId) {
                if (!vm.checkNodeStatus(nodeId)) {
                    return false;
                }
                // 如果是上传文件
                if (workflow.task[nodeId].type == "data-upload") {

                    return vm.upload(nodeId);
                } else {
                    let nodeStatus = {};
                    nodeStatus[nodeId] = status_map.RUNNING;
                    updateNodeStatus(nodeStatus);
                    // 发送请求
                    $.ajax({
                        url: api_map.node_run,
                        type: 'POST',
                        data: {
                            token: workflow.token,
                            nodeId: nodeId
                        },
                        dataType: 'json',
                        beforeSend: function () {

                        },
                        success: function (res) {
                            if (res.code == 0) {
                                console.log('节点运行中...');
                            } else {
                                alert(res.msg);
                                nodeStatus[nodeId] = res.code;
                                updateNodeStatus(nodeStatus);
                            }
                        },
                        error: function () {
                            nodeStatus[nodeId] = status_map.RUN_ERROR;
                            updateNodeStatus(nodeStatus);
                        }
                    });
                }
            },
            stopNode: function (nodeId) {
                vm.onNodeStop(nodeId);
            },
            onNodeRun: function (nodeId) {
                $('#' + nodeId + ' .run')
                        .attr('onclick', 'stopNode(' + nodeId + ')')
                        .attr('fill', '#1aad19 !important')
                        .text('\uf04d');
            },
            onNodeStop: function (nodeId) {
                $('#' + nodeId + ' .run')
                        .attr('onclick', 'runNode(' + nodeId + ')')
                        .attr('fill', '#1aad19 !important')
                        .text('\uf04b');
            },
            onNodeReRun: function (nodeId) {
                $('#' + nodeId + ' .run')
                        .attr('onclick', 'runNode(' + nodeId + ')')
                        .attr('fill', '#1aad19 !important')
                        .text('\uf021');
            },

            runCmd: function (cmd) {
                console.log(cmd);
                $.ajax({
                    url: api_map.cmd_run,
                    type: 'POST',
                    data: {
                        token: workflow.token,
                        flowId: vm.currentFlowId,
                        cmd: cmd,
                    },
                    dataType: "json",
                    success: function (res) {
                        if (res.code != 0) {
                            alert(res.msg);
                        }
                    },
                    error: function (e) {
                        console.log(e);
                    }
                });
            },

            configComponent: function (id, type) {
                onComponentDetail(id, type, true);
                onComponentConfig();
            },
            saveComponentConfig: function () {
                console.log('save config');
                onComponentConfigSave(vm.component);
            },
            deleteComponent: function () {
                onComponentDelete(vm.component.id, vm.component.type);
            },

            checkNodeStatus: function (nodeId, callback = null) {
                // Check: 检测节点状态是否满足要求
                var node = $('#' + nodeId);
                var status = node.attr('status');
                if (status == status_map.INIT_SUCCESS && callback != null) {
                    callback();
                }
                if (status == status_map.RUNNING || status == status_map.DEACTIVATE) {
                    // alert('状态不正确');
                    return false;
                }
                if (status == status_map.RUN_SUCCESS) {
                    if (run_policy == run_policy_map.MODIFIED_NODE) {
                        return false;
                    }
                }
                return true;
            },

            getNodeStatus: function (nodeId) {
                var node = $('#' + nodeId);
                var status = node.attr('status');
                return status;
            },
            checkUploadFile: function (callback) {
                let nodes = vm.flows[vm.currentFlowId].nodes;
                for (let i = 0, len = nodes.length; i < len; i++) {
                    let nodeId = nodes[i];
                    if (workflow.task[nodeId].type == 'data-upload'
                            && workflow.task[nodeId].path
                            && (workflow.task[nodeId].status == status_map.INIT_SUCCESS
                            || workflow.task[nodeId].status == status_map.DEACTIVATE)) {
                        vm.upload(nodeId);
                    }
                }
                callback();
            },

            changeTab: function (tab) {
                $('.red-ui-tab-link-buttons a').removeClass('active selected');
                $('#sidebar-content > div').css({display: 'none'});
                $('#sidebar-tabs li').removeClass('active');
                var div = $('.sidebar-' + tab);
                div.parent().css({display: 'block'});

                $('#red-ui-tab-' + tab + '-link-button').addClass('active selected');
                $('#sidebar-tabs #red-ui-tab-' + tab).addClass('active');
            },
            disabledA: function (selector) {
                let ele = $(selector);
                ele.addClass('disabled');
                ele.css("pointer-events", "none");
            },
            enableA: function (selector) {
                let ele = $(selector);
                ele.removeClass('disabled');
                ele.css("pointer-events", "");
            },

            logout: function () {
                // 保存当前工作流
                vm.saveWorkflow();
                // 跳转至登陆界面
                window.location.href = 'login.html';
            },

            getFile: function (event) {
                vm.uploadFile = true;
                console.log(event.target.files);
                // 获取文件对象
                vm.uploadFilePaths = event.target.files[0];
                // 将文件保存至cookie
                // setCookie(vm.component.id, vm.uploadFilePaths, 2);
                console.log(vm.uploadFilePaths.name);
                vm.component.params.path.default = vm.uploadFilePaths.name;
            },

            cleanCache: function () {
                // $.ajax({
                //     url: api_map.cache_clean,
                //     type: 'POST',
                //     data: {
                //         token: workflow.token
                //     },
                //     dataType: 'json',
                //     success: function (res) {
                //         if (res.code == 0) {
                //             console.log('缓存清除成功');
                //             window.location.href = 'login.html';
                //         } else {
                //             alert(res.msg);
                //         }
                //     },
                //     error: function (res) {
                //         alert('缓存清除失败！');
                //     }
                // });
                onComponentDelete(null, 'all');
            },

            getDataSetList: function () {
                $.ajax({
                    url: api_map.data_list,
                    type: 'POST',
                    data: {
                        token: workflow.token
                    },
                    dataType: 'json',
                    success: function (res) {
                        if (res.code == 0) {
                            vm.dataSets = res.data;
                            for (let id in vm.dataSets) {
                                vm.dataSet = vm.dataSets[id];
                                break;
                            }
                        } else {
                            alert(res.msg);
                        }
                    },
                    error: function (res) {
                    }
                });

//                $.getJSON("../data/metaData_debug.json", function (res) {
//                    if (res.code == 0) {
//                        vm.dataSets = res.data;
//
//                        for (let id in vm.dataSets) {
//                            vm.dataSet = vm.dataSets[id];
//                            break;
//                        }
//                    } else {
//                        alert(res.msg);
//                    }
//                });
            },
            onDataSetChanged: function (ele) {
                if (ele.target.value < 0) {
                    return;
                }
                vm.dataLoadConfigLock = false;
                vm.dataSet = vm.dataSets[ele.target.value];
            },
            onRowSelected: function (id) {
                let type = workflow.task[id].type;
                onComponentDetail(id, type);
            },
            cutString: function (str) {
                return cutstr(str, 20);
            },
            update: function () {
                // 先重置各状态
                d3.selectAll('svg .node').attr('class', 'node');
                d3.selectAll('svg .cable').attr('class', 'cable');
                vm.enableA('#btn-deploy');
                vm.component = {
                    id: "",
                    name: "",
                    type: "",
                    params: [],
                    description: ""
                };
                vm.path = {
                    id: "",
                    from: "",
                    to: ""
                };
                vm.uploadFile = false;

                // 判断flowId是否存在
                if (!workflow.task[workflow.currentFlowId]) {
                    return;
                }
                // 更新组件
                vm.component = getComponent(workflow.currentFlowId, 'flow', vm.lang);
                // 清空可视化区域
                $('.visual-chart').attr('style', 'display:none');
                // 更新各节点状态
                let status = {};
                let nodesList = workflow.task[workflow.currentFlowId].nodes;
                for (let i = 0, len = nodesList.length; i < len; i++) {
                    let nodeId = nodesList[i];
                    status[nodeId] = workflow.task[nodeId].status;
                }
                updateNodeStatus(status);
            },
            debug: function () {
            }
        },
        watch: {
            nodeFilter(filter){
                let nodeCategoryAll = deepClone(this.nodeCategoryCopy);
                for (let module in nodeCategoryAll) {
                    if (nodeCategoryAll[module].sub_modules) {
                        let subModules = nodeCategoryAll[module].sub_modules;
                        for (let subModule in subModules) {
                            for (let node in subModules[subModule].nodes) {
                                let nodeName = subModules[subModule].nodes[node][this.lang];
                                if (nodeName.indexOf(filter) == -1) {
                                    delete subModules[subModule].nodes[node];
                                }
                            }
                            if (JSON.stringify(subModules[subModule].nodes) == "{}") {
                                delete subModules[subModule];
                            }
                        }
                        if (JSON.stringify(subModules) == "{}") {
                            delete nodeCategoryAll[module];
                        }
                    } else {
                        for (let node in nodeCategoryAll[module].nodes) {
                            let nodeName = nodeCategoryAll[module].nodes[node][this.lang];
                            if (nodeName.indexOf(filter) == -1) {
                                delete nodeCategoryAll[module].nodes[node];
                            }
                        }
                        if (JSON.stringify(nodeCategoryAll[module].nodes) == "{}") {
                            delete nodeCategoryAll[module];
                        }
                    }
                }
                this.nodeCategory = nodeCategoryAll;
            },
            configFlag(flag){
                console.log("正在配置", flag);
                if (!flag) {
                    $('.ms-parent').remove();
                }
            }
        }
    });

    // 更改语言
    function changLang() {
        if (vm.lang == 'en') {
            vm.lang = 'zh';
        } else {
            vm.lang = 'en';
        }
        setCookie('lang', vm.lang, 24, "/");
    }
</script>
<script src="../public/common/echarts/echarts.js"></script>
<script src="../public/common/underscore/underscore-1.8.2.min.js"></script>
<script src="../public/common/layui/layui.js"></script>
